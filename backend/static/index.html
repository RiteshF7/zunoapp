<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Zuno</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet" />
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            bg: 'var(--c-bg)',
            surface: 'var(--c-surface)',
            'surface-hover': 'var(--c-surface-hover)',
            border: 'var(--c-border)',
            accent: { DEFAULT: '#6366f1', hover: '#818cf8' },
            muted: 'var(--c-muted)',
            heading: 'var(--c-heading)',
            body: 'var(--c-body)',
            success: '#22c55e',
            warning: '#f59e0b',
            danger: '#ef4444',
          },
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          borderRadius: { DEFAULT: '1.25rem', xl: '1.5rem', '2xl': '2rem' },
          boxShadow: {
            card: '0 1px 3px var(--c-shadow)',
            elevated: '0 8px 24px var(--c-shadow)',
          },
        },
      },
    };
  </script>
  <style>
    /* ── Theme Variables ── */
    :root {
      --c-bg: #F8FAFC;
      --c-surface: #FFFFFF;
      --c-surface-hover: #F1F5F9;
      --c-border: #E2E8F0;
      --c-muted: #64748B;
      --c-heading: #0f172a;
      --c-body: #334155;
      --c-shadow: rgba(0,0,0,0.06);
      --c-nav-bg: rgba(248,250,252,0.92);
    }
    .dark {
      --c-bg: #0f1117;
      --c-surface: #1a1d27;
      --c-surface-hover: #242836;
      --c-border: #2a2e3a;
      --c-muted: #9ca3af;
      --c-heading: #f1f5f9;
      --c-body: #cbd5e1;
      --c-shadow: rgba(0,0,0,0.35);
      --c-nav-bg: rgba(26,29,39,0.92);
    }

    /* ── Base ── */
    body {
      font-family: 'Inter', sans-serif;
      -webkit-tap-highlight-color: transparent;
      background: var(--c-bg);
      color: var(--c-body);
    }
    * { box-sizing: border-box; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    pre { white-space: pre-wrap; word-break: break-word; }

    /* ── Focus ── */
    :focus-visible { outline: 2px solid #6366f1; outline-offset: 2px; border-radius: 8px; }

    /* ── Safe Area ── */
    .safe-top { padding-top: env(safe-area-inset-top, 0px); }
    .safe-bottom { padding-bottom: env(safe-area-inset-bottom, 0px); }

    /* ── Animations ── */
    .fade-in { animation: fadeIn .25s ease-out; }
    .slide-in-right { animation: slideRight .25s ease-out; }
    .slide-in-left { animation: slideLeft .25s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideRight { from { opacity: 0; transform: translateX(24px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes slideLeft { from { opacity: 0; transform: translateX(-24px); } to { opacity: 1; transform: translateX(0); } }

    .spinner { border: 3px solid var(--c-border); border-top-color: #6366f1; border-radius: 50%; width: 24px; height: 24px; animation: spin .6s linear infinite; display: inline-block; }
    @keyframes spin { to { transform: rotate(360deg); } }

    @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
    .skeleton-line {
      background: linear-gradient(90deg, var(--c-surface-hover) 25%, var(--c-border) 50%, var(--c-surface-hover) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s ease-in-out infinite;
      border-radius: 8px;
    }

    .typing-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--c-muted); display: inline-block; animation: typingBounce .8s ease-in-out infinite; }
    .typing-dot:nth-child(2) { animation-delay: .15s; }
    .typing-dot:nth-child(3) { animation-delay: .3s; }
    @keyframes typingBounce { 0%,60%,100% { transform: translateY(0); } 30% { transform: translateY(-6px); } }

    @keyframes bookmarkPop { 0% { transform: scale(1); } 40% { transform: scale(1.3); } 100% { transform: scale(1); } }
    .bookmark-pop { animation: bookmarkPop .3s ease-out; }

    @keyframes checkBounce { 0% { transform: scale(0.8); } 50% { transform: scale(1.15); } 100% { transform: scale(1); } }
    .check-bounce { animation: checkBounce .3s ease-out; }

    @keyframes toastSlide { from { opacity: 0; transform: translate(-50%, -12px); } to { opacity: 1; transform: translate(-50%, 0); } }
    .toast-enter { animation: toastSlide .25s ease-out forwards; }

    @keyframes modalUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }
    .modal-up { animation: modalUp .3s cubic-bezier(.16,1,.3,1); }

    /* ── Progress Ring ── */
    .progress-ring-circle { transition: stroke-dashoffset 0.5s ease; }

    /* ── Nav Glass ── */
    .nav-glass {
      background: var(--c-nav-bg);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }

    /* ── Scrollbar ── */
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--c-border); border-radius: 4px; }
  </style>
</head>
<body class="min-h-screen antialiased">

  <!-- Skip to content (accessibility) -->
  <a href="#page" class="sr-only focus:not-sr-only focus:fixed focus:top-2 focus:left-2 focus:z-[100] focus:bg-accent focus:text-white focus:px-4 focus:py-2 focus:rounded-xl focus:text-sm focus:font-semibold">
    Skip to content
  </a>

  <!-- ======================= APP SHELL ======================= -->
  <div id="app" class="max-w-2xl mx-auto min-h-screen flex flex-col relative">

    <!-- Top Nav -->
    <header id="topnav" role="banner" class="hidden sticky top-0 z-30 nav-glass border-b border-border px-5 py-3 items-center justify-between safe-top">
      <span class="text-lg font-bold tracking-tight text-heading">Zuno</span>
      <div class="flex items-center gap-1">
        <button onclick="navigate('#search')" class="p-2.5 rounded-xl hover:bg-surface-hover transition-colors" aria-label="Search">
          <span class="material-icons-round text-[22px] text-muted">search</span>
        </button>
        <button onclick="navigate('#profile')" class="p-2.5 rounded-xl hover:bg-surface-hover transition-colors" aria-label="Profile">
          <span class="material-icons-round text-[22px] text-muted">account_circle</span>
        </button>
      </div>
    </header>

    <!-- Page Content -->
    <main id="page" role="main" class="flex-1 px-5 py-4 pb-24" aria-live="polite"></main>

    <!-- FAB (Library page only) -->
    <button id="fab-btn" class="hidden fixed bottom-24 right-5 z-20 w-14 h-14 bg-accent hover:bg-accent-hover text-white rounded-full shadow-elevated flex items-center justify-center active:scale-90 transition-transform" aria-label="Add content" onclick="openSaveContentModal()">
      <span class="material-icons-round text-2xl">add</span>
    </button>

    <!-- Bottom Nav (4 tabs) -->
    <nav id="bottomnav" role="navigation" aria-label="Main navigation" class="hidden fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-2xl nav-glass border-t border-border z-30 safe-bottom">
      <div class="flex justify-around py-1.5">
        <button onclick="navigate('#home')" data-tab="home" class="nav-btn flex flex-col items-center gap-0.5 min-w-[64px] py-2 rounded-xl transition-all duration-200" aria-label="Home">
          <span class="material-icons-round text-[22px]">home</span>
          <span class="text-[10px] font-medium">Home</span>
        </button>
        <button onclick="navigate('#library')" data-tab="library" class="nav-btn flex flex-col items-center gap-0.5 min-w-[64px] py-2 rounded-xl transition-all duration-200" aria-label="Library">
          <span class="material-icons-round text-[22px]">collections_bookmark</span>
          <span class="text-[10px] font-medium">Library</span>
        </button>
        <button onclick="navigate('#goals')" data-tab="goals" class="nav-btn flex flex-col items-center gap-0.5 min-w-[64px] py-2 rounded-xl transition-all duration-200" aria-label="Goals">
          <span class="material-icons-round text-[22px]">flag</span>
          <span class="text-[10px] font-medium">Goals</span>
        </button>
        <button onclick="navigate('#knowledge')" data-tab="knowledge" class="nav-btn flex flex-col items-center gap-0.5 min-w-[64px] py-2 rounded-xl transition-all duration-200" aria-label="Ask AI">
          <span class="material-icons-round text-[22px]">psychology</span>
          <span class="text-[10px] font-medium">Ask</span>
        </button>
      </div>
    </nav>
  </div>

  <!-- ======================= MODAL OVERLAY ======================= -->
  <div id="modal-overlay" class="hidden fixed inset-0 z-50 bg-black/50 flex items-end sm:items-center justify-center" onclick="if(event.target===this)closeModal()">
    <div id="modal-content" class="bg-surface rounded-t-2xl sm:rounded-2xl w-full max-w-lg max-h-[85vh] overflow-y-auto no-scrollbar p-6 modal-up"></div>
  </div>

  <!-- ======================= CONFIRM DIALOG ======================= -->
  <div id="confirm-overlay" class="hidden fixed inset-0 z-[60] bg-black/50 flex items-end sm:items-center justify-center">
    <div id="confirm-content" class="bg-surface rounded-t-2xl sm:rounded-2xl w-full max-w-sm p-6 modal-up"></div>
  </div>

  <!-- ======================= TOAST ======================= -->
  <div id="toast" class="fixed top-4 left-1/2 -translate-x-1/2 z-[70] hidden" role="status" aria-live="polite">
    <div class="bg-surface border border-border rounded-xl px-4 py-3 shadow-elevated text-sm font-medium flex items-center gap-2.5 toast-enter">
      <span class="toast-icon material-icons-round text-lg"></span>
      <span class="toast-msg"></span>
    </div>
  </div>

<script>
// ═══════════════════════════════════════════════════════════════════════════
// THEME MANAGEMENT
// ═══════════════════════════════════════════════════════════════════════════
function initTheme() {
  const saved = localStorage.getItem('zuno_theme') || 'system';
  applyTheme(saved);
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
    if ((localStorage.getItem('zuno_theme') || 'system') === 'system') applyTheme('system');
  });
}

function applyTheme(mode) {
  localStorage.setItem('zuno_theme', mode);
  const isDark = mode === 'dark' || (mode === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches);
  document.documentElement.classList.toggle('dark', isDark);
}

function getTheme() { return localStorage.getItem('zuno_theme') || 'system'; }

initTheme();

// ═══════════════════════════════════════════════════════════════════════════
// API HELPER
// ═══════════════════════════════════════════════════════════════════════════
const API_BASE = window.location.origin;

async function api(method, path, body = null, params = null) {
  const token = localStorage.getItem('zuno_token');
  const headers = {};
  if (token) headers['Authorization'] = `Bearer ${token}`;

  let url = `${API_BASE}${path}`;
  if (params) {
    const sp = new URLSearchParams();
    Object.entries(params).forEach(([k, v]) => { if (v !== '' && v != null) sp.append(k, v); });
    const qs = sp.toString();
    if (qs) url += '?' + qs;
  }

  const opts = { method, headers };
  if (body && ['POST', 'PATCH', 'PUT', 'DELETE'].includes(method)) {
    headers['Content-Type'] = 'application/json';
    opts.body = JSON.stringify(body);
  }

  try {
    const res = await fetch(url, opts);
    const text = await res.text();
    let data;
    try { data = JSON.parse(text); } catch { data = text; }
    return { ok: res.ok, status: res.status, data };
  } catch (err) {
    return { ok: false, status: 0, data: { error: err.message } };
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// TOAST / MODAL / CONFIRM HELPERS
// ═══════════════════════════════════════════════════════════════════════════
function toast(msg, isError = false) {
  const el = document.getElementById('toast');
  el.querySelector('.toast-msg').textContent = msg;
  const icon = el.querySelector('.toast-icon');
  icon.textContent = isError ? 'error_outline' : 'check_circle';
  icon.className = `toast-icon material-icons-round text-lg ${isError ? 'text-danger' : 'text-success'}`;
  el.classList.remove('hidden');
  clearTimeout(el._t);
  el._t = setTimeout(() => el.classList.add('hidden'), 3000);
}

function openModal(html) {
  document.getElementById('modal-content').innerHTML = html;
  document.getElementById('modal-overlay').classList.remove('hidden');
}

function closeModal() {
  document.getElementById('modal-overlay').classList.add('hidden');
}

function customConfirm(title, message, confirmText = 'Confirm', isDanger = false) {
  return new Promise(resolve => {
    const overlay = document.getElementById('confirm-overlay');
    document.getElementById('confirm-content').innerHTML = `
      <h3 class="text-lg font-bold text-heading mb-2">${title}</h3>
      <p class="text-muted text-sm mb-6">${message}</p>
      <div class="flex gap-3">
        <button id="confirm-cancel" class="flex-1 py-3 rounded-xl text-sm font-semibold bg-surface-hover text-heading hover:bg-border transition-colors active:scale-[0.97]">Cancel</button>
        <button id="confirm-ok" class="flex-1 py-3 rounded-xl text-sm font-semibold text-white transition-colors active:scale-[0.97] ${isDanger ? 'bg-danger hover:bg-red-600' : 'bg-accent hover:bg-accent-hover'}">${confirmText}</button>
      </div>`;
    overlay.classList.remove('hidden');
    document.getElementById('confirm-cancel').onclick = () => { overlay.classList.add('hidden'); resolve(false); };
    document.getElementById('confirm-ok').onclick = () => { overlay.classList.add('hidden'); resolve(true); };
  });
}

// ═══════════════════════════════════════════════════════════════════════════
// SKELETON / LOADING HELPERS
// ═══════════════════════════════════════════════════════════════════════════
function skeletonCards(count = 3) {
  return Array(count).fill(0).map(() => `
    <div class="bg-surface rounded-2xl p-4 shadow-card">
      <div class="flex gap-3">
        <div class="w-20 h-20 rounded-xl skeleton-line flex-shrink-0"></div>
        <div class="flex-1 space-y-2.5 py-1">
          <div class="h-4 skeleton-line w-3/4"></div>
          <div class="h-3 skeleton-line w-full"></div>
          <div class="h-3 skeleton-line w-1/3"></div>
        </div>
      </div>
    </div>`).join('');
}

function skeletonGrid(count = 4) {
  return `<div class="grid grid-cols-2 gap-3">${Array(count).fill(0).map(() => `
    <div class="rounded-2xl p-4 h-36 skeleton-line"></div>`).join('')}</div>`;
}

function skeletonDetail() {
  return `
    <div class="space-y-4">
      <div class="h-48 rounded-2xl skeleton-line"></div>
      <div class="h-6 skeleton-line w-2/3"></div>
      <div class="h-4 skeleton-line w-full"></div>
      <div class="h-4 skeleton-line w-5/6"></div>
      <div class="flex gap-2"><div class="h-6 w-16 rounded-full skeleton-line"></div><div class="h-6 w-20 rounded-full skeleton-line"></div></div>
    </div>`;
}

function loadingSpinner() {
  return '<div class="flex justify-center py-12"><div class="spinner"></div></div>';
}

// ═══════════════════════════════════════════════════════════════════════════
// ROUTER
// ═══════════════════════════════════════════════════════════════════════════
let _prevPage = null;
const _detailPages = ['content-detail', 'collection', 'goal-detail'];

function navigate(hash) { window.location.hash = hash; }

function getRoute() {
  const h = window.location.hash || '#auth';
  const parts = h.replace('#', '').split('/');
  return { page: parts[0], id: parts[1] || null };
}

function getTransition(page) {
  if (!_prevPage) return 'fade-in';
  if (_detailPages.includes(page) && !_detailPages.includes(_prevPage)) return 'slide-in-right';
  if (_detailPages.includes(_prevPage) && !_detailPages.includes(page)) return 'slide-in-left';
  return 'fade-in';
}

async function router() {
  const token = localStorage.getItem('zuno_token');
  const { page, id } = getRoute();

  // Auth guard
  if (!token && page !== 'auth') { navigate('#auth'); return; }
  if (token && page === 'auth') { navigate('#home'); return; }

  // Backward compat redirects
  if (page === 'feed') { navigate('#home'); return; }
  if (page === 'content') { navigate('#library'); return; }
  if (page === 'collections') { navigate('#library'); return; }
  if (page === 'admin') { navigate('#profile'); return; }

  // Show/hide shell
  const isAuth = page === 'auth';
  document.getElementById('topnav').classList.toggle('hidden', isAuth);
  document.getElementById('topnav').classList.toggle('flex', !isAuth);
  document.getElementById('bottomnav').classList.toggle('hidden', isAuth);
  document.getElementById('fab-btn').classList.toggle('hidden', page !== 'library');

  // Update active nav tab
  const tabMap = {
    home: 'home', library: 'library', 'content-detail': 'library', collection: 'library',
    goals: 'goals', 'goal-detail': 'goals', knowledge: 'knowledge',
  };
  document.querySelectorAll('.nav-btn').forEach(btn => {
    const active = btn.dataset.tab === tabMap[page];
    btn.classList.toggle('text-accent', active);
    btn.classList.toggle('text-muted', !active);
  });

  const main = document.getElementById('page');
  const transition = getTransition(page);
  _prevPage = page;

  // Show skeleton loading
  const skeletonMap = {
    home: skeletonCards(3),
    library: skeletonCards(3),
    goals: skeletonCards(3),
    'content-detail': skeletonDetail(),
    'goal-detail': skeletonDetail(),
    collection: skeletonDetail(),
  };
  main.innerHTML = `<div class="${transition}">${skeletonMap[page] || loadingSpinner()}</div>`;

  try {
    switch (page) {
      case 'auth': renderAuth(main); break;
      case 'home': await renderHome(main); break;
      case 'library': await renderLibrary(main, id); break;
      case 'content-detail': await renderContentDetail(main, id); break;
      case 'collection': await renderCollectionDetail(main, id); break;
      case 'goals': await renderGoals(main); break;
      case 'goal-detail': await renderGoalDetail(main, id); break;
      case 'search': await renderSearch(main); break;
      case 'knowledge': await renderKnowledge(main); break;
      case 'profile': await renderProfile(main); break;
      default: navigate('#home');
    }
  } catch (err) {
    main.innerHTML = `<div class="flex flex-col items-center justify-center py-16 text-center fade-in">
      <span class="material-icons-round text-5xl text-danger/40 mb-3">error_outline</span>
      <p class="text-heading font-semibold mb-1">Something went wrong</p>
      <p class="text-muted text-sm">${err.message}</p>
    </div>`;
  }
}

window.addEventListener('hashchange', router);
window.addEventListener('DOMContentLoaded', router);

// ═══════════════════════════════════════════════════════════════════════════
// UTILITY
// ═══════════════════════════════════════════════════════════════════════════
function esc(s) { if (!s) return ''; const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
function truncate(s, n = 100) { return s && s.length > n ? s.slice(0, n) + '...' : (s || ''); }

function badge(text, color = 'indigo') {
  if (!text) return '';
  return `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-semibold bg-${color}-500/15 text-${color}-600 dark:text-${color}-400">${esc(text)}</span>`;
}

function platformIcon(p) {
  const icons = { youtube: 'play_circle', instagram: 'camera_alt', x: 'tag', reddit: 'forum', tiktok: 'music_note', spotify: 'headphones', web: 'language' };
  return icons[p] || 'link';
}

function getGreeting() {
  const h = new Date().getHours();
  if (h < 12) return 'Good morning';
  if (h < 18) return 'Good afternoon';
  return 'Good evening';
}

let _userProfile = null;
async function getUserProfile(force = false) {
  if (_userProfile && !force) return _userProfile;
  const res = await api('GET', '/api/profile');
  if (res.ok) _userProfile = res.data;
  return _userProfile || {};
}

function formatDate() {
  return new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
}

// Universal content card
function contentCardHtml(item, opts = {}) {
  const id = item.content_id || item.id;
  const title = item.title || item.url || 'Untitled';
  const desc = item.description || item.ai_summary || '';
  const thumb = item.image_url || item.thumbnail_url;
  const cat = item.category || item.ai_category;
  const platform = item.platform;
  const showBookmark = opts.showBookmark || false;
  const isBookmarked = opts.isBookmarked || false;
  const showAiStatus = opts.showAiStatus || false;
  const aiProcessed = item.ai_processed;

  return `
    <article class="bg-surface rounded-2xl p-4 shadow-card hover:shadow-elevated transition-all duration-200 cursor-pointer active:scale-[0.97] group"
      onclick="if(!event.target.closest('.card-action'))navigate('#content-detail/${id}')">
      <div class="flex gap-3">
        ${thumb
          ? `<img src="${esc(thumb)}" alt="" class="w-20 h-20 rounded-xl object-cover flex-shrink-0" onerror="this.style.display='none'" loading="lazy"/>`
          : `<div class="w-20 h-20 rounded-xl bg-surface-hover flex items-center justify-center flex-shrink-0"><span class="material-icons-round text-2xl text-muted">${platformIcon(platform)}</span></div>`}
        <div class="flex-1 min-w-0">
          <div class="flex items-start justify-between gap-2">
            <h3 class="font-semibold text-heading text-sm leading-snug line-clamp-2">${esc(title)}</h3>
            ${showBookmark ? `
              <button class="card-action flex-shrink-0 p-1 rounded-lg hover:bg-surface-hover transition-colors" onclick="toggleBookmark('${item.id}', this)" aria-label="${isBookmarked ? 'Remove bookmark' : 'Add bookmark'}">
                <span class="material-icons-round text-lg ${isBookmarked ? 'text-accent bookmark-pop' : 'text-muted'}">${isBookmarked ? 'bookmark' : 'bookmark_border'}</span>
              </button>` : ''}
          </div>
          <p class="text-muted text-xs mt-1 line-clamp-2">${esc(truncate(desc, 120))}</p>
          <div class="flex items-center gap-2 mt-2 flex-wrap">
            ${badge(cat)}
            ${platform ? `<span class="text-muted text-[10px] flex items-center gap-0.5"><span class="material-icons-round text-xs">${platformIcon(platform)}</span>${esc(platform)}</span>` : ''}
            ${showAiStatus ? (aiProcessed
              ? '<span class="text-success text-[10px] flex items-center gap-0.5"><span class="material-icons-round text-xs">check_circle</span>AI</span>'
              : '<span class="text-muted text-[10px]">Pending</span>') : ''}
          </div>
        </div>
      </div>
    </article>`;
}

// Progress ring SVG
function progressRing(percent, size = 48, stroke = 4, color = '#6366f1') {
  const r = (size - stroke) / 2;
  const circ = 2 * Math.PI * r;
  const offset = circ - (circ * percent / 100);
  return `<svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" class="transform -rotate-90">
    <circle cx="${size/2}" cy="${size/2}" r="${r}" fill="none" stroke="var(--c-border)" stroke-width="${stroke}"/>
    <circle cx="${size/2}" cy="${size/2}" r="${r}" fill="none" stroke="${color}" stroke-width="${stroke}" stroke-dasharray="${circ}" stroke-dashoffset="${offset}" stroke-linecap="round" class="progress-ring-circle"/>
  </svg>`;
}

// Recent searches
function getRecentSearches() { try { return JSON.parse(localStorage.getItem('zuno_searches') || '[]'); } catch { return []; } }
function addRecentSearch(q) {
  const s = getRecentSearches().filter(x => x !== q);
  s.unshift(q);
  localStorage.setItem('zuno_searches', JSON.stringify(s.slice(0, 5)));
}

// ═══════════════════════════════════════════════════════════════════════════
// AUTH PAGE
// ═══════════════════════════════════════════════════════════════════════════
function renderAuth(el) {
  el.innerHTML = `
    <div class="flex flex-col items-center justify-center min-h-[80vh] fade-in">
      <div class="w-full max-w-sm">
        <div class="text-center mb-8">
          <div class="inline-flex items-center justify-center w-20 h-20 rounded-3xl bg-accent/15 mb-5">
            <span class="material-icons-round text-4xl text-accent">auto_awesome</span>
          </div>
          <h1 class="text-2xl font-bold text-heading">Welcome to Zuno</h1>
          <p class="text-muted text-sm mt-2">Your AI-powered content companion</p>
        </div>
        <div class="space-y-4">
          <div>
            <label for="jwt-input" class="text-xs text-muted font-medium mb-1.5 block">Authentication Token</label>
            <textarea id="jwt-input" rows="3" placeholder="Paste your JWT token here..." class="w-full bg-surface border border-border rounded-xl px-4 py-3 text-sm text-heading placeholder-muted/50 focus:outline-none focus:border-accent focus:ring-1 focus:ring-accent/30 resize-none font-mono" aria-label="JWT token input"></textarea>
          </div>
          <div id="auth-error" class="hidden text-danger text-sm text-center bg-danger/10 rounded-xl px-4 py-2.5"></div>
          <button id="auth-btn" onclick="doLogin()" class="w-full bg-accent hover:bg-accent-hover text-white font-semibold py-3.5 rounded-xl transition-colors active:scale-[0.97]">
            Sign In
          </button>
          <details class="text-center">
            <summary class="text-muted text-xs cursor-pointer hover:text-heading transition-colors">How to get your token</summary>
            <p class="text-muted text-xs mt-2 leading-relaxed bg-surface-hover rounded-xl p-3">Sign in to your Supabase project, go to Authentication, find your user, and copy the JWT access token from the API settings.</p>
          </details>
        </div>
      </div>
    </div>`;
}

async function doLogin() {
  const token = document.getElementById('jwt-input').value.trim();
  if (!token) {
    document.getElementById('auth-error').textContent = 'Please enter your authentication token';
    document.getElementById('auth-error').classList.remove('hidden');
    return;
  }
  const btn = document.getElementById('auth-btn');
  btn.innerHTML = '<div class="spinner" style="width:20px;height:20px;border-width:2px;"></div>';
  btn.disabled = true;

  localStorage.setItem('zuno_token', token);
  const res = await api('GET', '/api/profile');
  if (res.ok) {
    _userProfile = res.data;
    toast('Signed in as ' + (res.data.display_name || res.data.email || 'user'));
    navigate('#home');
  } else {
    localStorage.removeItem('zuno_token');
    document.getElementById('auth-error').textContent = 'Invalid token. Please check and try again.';
    document.getElementById('auth-error').classList.remove('hidden');
    btn.textContent = 'Sign In';
    btn.disabled = false;
  }
}

function doLogout() {
  localStorage.removeItem('zuno_token');
  _userProfile = null;
  navigate('#auth');
  toast('Signed out');
}

// ═══════════════════════════════════════════════════════════════════════════
// HOME (FEED) PAGE
// ═══════════════════════════════════════════════════════════════════════════
async function renderHome(el) {
  const profile = await getUserProfile();
  const prefRes = await api('GET', '/api/user-preferences');
  const feedType = prefRes.ok ? prefRes.data.feed_type : 'usersaved';

  const endpoint = feedType === 'suggestedcontent' ? '/api/suggested-feed' : '/api/feed';
  const [feedRes, bookmarkRes] = await Promise.all([
    api('GET', endpoint, null, { limit: 30 }),
    api('GET', '/api/bookmarks'),
  ]);

  const items = feedRes.ok ? (Array.isArray(feedRes.data) ? feedRes.data : feedRes.data.items || []) : [];
  const bookmarks = bookmarkRes.ok ? (Array.isArray(bookmarkRes.data) ? bookmarkRes.data : []) : [];
  const bookmarkSet = new Set(bookmarks);
  const name = profile.display_name || 'there';

  el.innerHTML = `
    <div class="fade-in">
      <!-- Greeting -->
      <section class="mb-6" aria-label="Greeting">
        <h1 class="text-2xl font-bold text-heading">${getGreeting()}, ${esc(name)}</h1>
        <p class="text-muted text-sm mt-0.5">${formatDate()}</p>
      </section>

      <!-- Feed Toggle -->
      <div class="flex bg-surface rounded-xl p-1 gap-1 mb-5 shadow-card" role="tablist" aria-label="Feed type">
        <button onclick="switchFeedType('usersaved')" role="tab" aria-selected="${feedType === 'usersaved'}" class="flex-1 py-2.5 text-sm font-medium rounded-lg transition-all duration-200 ${feedType === 'usersaved' ? 'bg-accent text-white shadow-sm' : 'text-muted hover:text-heading'}">My Feed</button>
        <button onclick="switchFeedType('suggestedcontent')" role="tab" aria-selected="${feedType === 'suggestedcontent'}" class="flex-1 py-2.5 text-sm font-medium rounded-lg transition-all duration-200 ${feedType === 'suggestedcontent' ? 'bg-accent text-white shadow-sm' : 'text-muted hover:text-heading'}">Suggested</button>
      </div>

      <!-- Feed Items -->
      ${items.length === 0 ? `
        <div class="flex flex-col items-center justify-center py-16 text-center">
          <div class="w-20 h-20 rounded-3xl bg-accent/10 flex items-center justify-center mb-4">
            <span class="material-icons-round text-4xl text-accent/60">dynamic_feed</span>
          </div>
          <p class="text-heading font-semibold mb-1">Your feed is empty</p>
          <p class="text-muted text-sm mb-4">Save some content to start building your feed</p>
          <button onclick="navigate('#library')" class="bg-accent hover:bg-accent-hover text-white text-sm font-semibold px-6 py-2.5 rounded-xl transition-colors active:scale-[0.97]">Go to Library</button>
        </div>` : `
        <div class="space-y-3" id="feed-list" role="feed" aria-label="Feed items">
          ${items.map(item => contentCardHtml(item, { showBookmark: true, isBookmarked: bookmarkSet.has(item.id) })).join('')}
        </div>`}
    </div>`;
}

async function switchFeedType(type) {
  await api('PATCH', '/api/user-preferences', { feed_type: type });
  await router();
}

async function toggleBookmark(feedItemId, btn) {
  const res = await api('POST', `/api/bookmarks/${feedItemId}/toggle`);
  if (res.ok) {
    const icon = btn.querySelector('span');
    const isNow = res.data?.bookmarked ?? !icon.textContent.includes('border');
    icon.textContent = isNow ? 'bookmark' : 'bookmark_border';
    icon.classList.toggle('text-accent', isNow);
    icon.classList.toggle('text-muted', !isNow);
    if (isNow) icon.classList.add('bookmark-pop');
    else icon.classList.remove('bookmark-pop');
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// LIBRARY PAGE (Content + Collections)
// ═══════════════════════════════════════════════════════════════════════════
let _libraryTab = 'saved';

async function renderLibrary(el, subTab) {
  if (subTab === 'saved' || subTab === 'collections') _libraryTab = subTab;
  const isSaved = _libraryTab === 'saved';

  if (isSaved) {
    await renderLibrarySaved(el);
  } else {
    await renderLibraryCollections(el);
  }
}

async function renderLibrarySaved(el) {
  const res = await api('GET', '/api/content', null, { limit: 50 });
  const items = res.ok ? (Array.isArray(res.data) ? res.data : []) : [];

  el.innerHTML = `
    <div class="fade-in">
      <h1 class="text-xl font-bold text-heading mb-4">Library</h1>

      <!-- Tabs -->
      <div class="flex bg-surface rounded-xl p-1 gap-1 mb-5 shadow-card" role="tablist" aria-label="Library view">
        <button onclick="switchLibraryTab('saved')" role="tab" aria-selected="true" class="flex-1 py-2.5 text-sm font-medium rounded-lg transition-all duration-200 bg-accent text-white shadow-sm">Saved</button>
        <button onclick="switchLibraryTab('collections')" role="tab" aria-selected="false" class="flex-1 py-2.5 text-sm font-medium rounded-lg transition-all duration-200 text-muted hover:text-heading">Collections</button>
      </div>

      ${items.length === 0 ? `
        <div class="flex flex-col items-center justify-center py-16 text-center">
          <div class="w-20 h-20 rounded-3xl bg-accent/10 flex items-center justify-center mb-4">
            <span class="material-icons-round text-4xl text-accent/60">bookmark_border</span>
          </div>
          <p class="text-heading font-semibold mb-1">No saved content yet</p>
          <p class="text-muted text-sm mb-4">Tap the + button to save your first item</p>
        </div>` : `
        <div class="space-y-3" id="content-list">
          ${items.map(item => contentCardHtml(item, { showAiStatus: true })).join('')}
        </div>`}
    </div>`;
}

async function renderLibraryCollections(el) {
  const [colRes, catRes] = await Promise.all([
    api('GET', '/api/collections'),
    api('GET', '/api/collections/categories'),
  ]);
  const cols = colRes.ok ? (Array.isArray(colRes.data) ? colRes.data : []) : [];
  const cats = catRes.ok ? (Array.isArray(catRes.data) ? catRes.data : []) : [];

  const themeColors = {
    blue: 'from-blue-500/20 to-blue-600/5 border-blue-500/20',
    green: 'from-green-500/20 to-green-600/5 border-green-500/20',
    purple: 'from-purple-500/20 to-purple-600/5 border-purple-500/20',
    amber: 'from-amber-500/20 to-amber-600/5 border-amber-500/20',
    rose: 'from-rose-500/20 to-rose-600/5 border-rose-500/20',
    indigo: 'from-indigo-500/20 to-indigo-600/5 border-indigo-500/20',
  };

  el.innerHTML = `
    <div class="fade-in">
      <h1 class="text-xl font-bold text-heading mb-4">Library</h1>

      <!-- Tabs -->
      <div class="flex bg-surface rounded-xl p-1 gap-1 mb-5 shadow-card" role="tablist" aria-label="Library view">
        <button onclick="switchLibraryTab('saved')" role="tab" aria-selected="false" class="flex-1 py-2.5 text-sm font-medium rounded-lg transition-all duration-200 text-muted hover:text-heading">Saved</button>
        <button onclick="switchLibraryTab('collections')" role="tab" aria-selected="true" class="flex-1 py-2.5 text-sm font-medium rounded-lg transition-all duration-200 bg-accent text-white shadow-sm">Collections</button>
      </div>

      ${cats.length > 0 ? `
        <div class="mb-5">
          <h2 class="text-xs font-semibold text-muted uppercase tracking-wide mb-2">AI Categories</h2>
          <div class="flex flex-wrap gap-1.5">
            ${cats.map(c => `<span class="px-2.5 py-1 rounded-lg bg-surface border border-border text-xs text-body">${esc(typeof c === 'string' ? c : c.name || c.category || '')}</span>`).join('')}
          </div>
        </div>` : ''}

      ${cols.length === 0 ? `
        <div class="flex flex-col items-center justify-center py-16 text-center">
          <div class="w-20 h-20 rounded-3xl bg-accent/10 flex items-center justify-center mb-4">
            <span class="material-icons-round text-4xl text-accent/60">folder_open</span>
          </div>
          <p class="text-heading font-semibold mb-1">No collections yet</p>
          <p class="text-muted text-sm mb-4">Create your first collection to organize content</p>
          <button onclick="openCreateCollectionModal()" class="bg-accent hover:bg-accent-hover text-white text-sm font-semibold px-6 py-2.5 rounded-xl transition-colors active:scale-[0.97]">Create Collection</button>
        </div>` : `
        <div class="grid grid-cols-2 gap-3">
          ${cols.map(c => {
            const tc = themeColors[c.theme] || themeColors.blue;
            return `
            <article onclick="navigate('#collection/${c.id}')" class="bg-gradient-to-br ${tc} border rounded-2xl p-4 cursor-pointer hover:scale-[1.02] transition-all duration-200 active:scale-[0.97] shadow-card h-36 flex flex-col justify-between">
              <span class="material-icons-round text-2xl text-heading/80">${esc(c.icon || 'folder')}</span>
              <div>
                <h3 class="text-heading font-semibold text-sm leading-snug line-clamp-1">${esc(c.title)}</h3>
                <p class="text-muted text-xs mt-0.5">${c.item_count} item${c.item_count !== 1 ? 's' : ''}</p>
                ${c.is_shared ? '<span class="text-[10px] text-accent font-medium">Shared</span>' : ''}
              </div>
            </article>`;
          }).join('')}
          <!-- Add Collection Card -->
          <button onclick="openCreateCollectionModal()" class="border-2 border-dashed border-border rounded-2xl h-36 flex flex-col items-center justify-center gap-2 hover:border-accent hover:bg-accent/5 transition-all duration-200 active:scale-[0.97]" aria-label="Create new collection">
            <span class="material-icons-round text-2xl text-muted">add</span>
            <span class="text-muted text-xs font-medium">New Collection</span>
          </button>
        </div>`}
    </div>`;
}

function switchLibraryTab(tab) {
  _libraryTab = tab;
  navigate('#library/' + tab);
}

function openSaveContentModal() {
  openModal(`
    <h2 class="text-lg font-bold text-heading mb-4">Save Content</h2>
    <div class="space-y-4">
      <div>
        <label for="m-url" class="text-xs text-muted font-medium mb-1.5 block">URL</label>
        <input id="m-url" type="url" placeholder="Paste a link..." class="w-full bg-bg border border-border rounded-xl px-4 py-3 text-sm text-heading placeholder-muted/50 focus:outline-none focus:border-accent focus:ring-1 focus:ring-accent/30" autofocus />
        <p class="text-[11px] text-muted mt-1.5">Title, description, platform &amp; type are auto-detected</p>
      </div>
      <button onclick="doSaveContent()" id="save-content-btn" class="w-full bg-accent hover:bg-accent-hover text-white font-semibold py-3.5 rounded-xl transition-colors active:scale-[0.97]">Save Content</button>
    </div>
  `);
}

async function doSaveContent() {
  const url = document.getElementById('m-url').value.trim();
  if (!url) { toast('URL is required', true); return; }
  const btn = document.getElementById('save-content-btn');
  btn.innerHTML = '<div class="spinner" style="width:18px;height:18px;border-width:2px;"></div>';
  btn.disabled = true;
  const res = await api('POST', '/api/content', { url });
  if (res.ok) {
    closeModal();
    toast('Content saved!');
    navigate('#content-detail/' + res.data.id);
  } else {
    toast(res.data?.detail || 'Failed to save', true);
    btn.textContent = 'Save Content';
    btn.disabled = false;
  }
}

function openCreateCollectionModal() {
  openModal(`
    <h2 class="text-lg font-bold text-heading mb-4">New Collection</h2>
    <div class="space-y-4">
      <div>
        <label for="c-title" class="text-xs text-muted font-medium mb-1.5 block">Title *</label>
        <input id="c-title" placeholder="Collection name" class="w-full bg-bg border border-border rounded-xl px-4 py-3 text-sm text-heading placeholder-muted/50 focus:outline-none focus:border-accent focus:ring-1 focus:ring-accent/30" />
      </div>
      <div>
        <label for="c-desc" class="text-xs text-muted font-medium mb-1.5 block">Description</label>
        <textarea id="c-desc" rows="2" placeholder="Optional description" class="w-full bg-bg border border-border rounded-xl px-4 py-3 text-sm text-heading placeholder-muted/50 focus:outline-none focus:border-accent focus:ring-1 focus:ring-accent/30 resize-none"></textarea>
      </div>
      <div class="grid grid-cols-2 gap-3">
        <div>
          <label for="c-icon" class="text-xs text-muted font-medium mb-1.5 block">Icon</label>
          <input id="c-icon" value="folder" class="w-full bg-bg border border-border rounded-xl px-4 py-3 text-sm text-heading focus:outline-none focus:border-accent focus:ring-1 focus:ring-accent/30" />
        </div>
        <div>
          <label for="c-theme" class="text-xs text-muted font-medium mb-1.5 block">Theme</label>
          <select id="c-theme" class="w-full bg-bg border border-border rounded-xl px-4 py-3 text-sm text-heading focus:outline-none focus:border-accent">
            <option value="blue">Blue</option><option value="green">Green</option><option value="purple">Purple</option>
            <option value="amber">Amber</option><option value="rose">Rose</option><option value="indigo">Indigo</option>
          </select>
        </div>
      </div>
      <button onclick="doCreateCollection()" id="create-col-btn" class="w-full bg-accent hover:bg-accent-hover text-white font-semibold py-3.5 rounded-xl transition-colors active:scale-[0.97]">Create Collection</button>
    </div>
  `);
}

async function doCreateCollection() {
  const title = document.getElementById('c-title').value.trim();
  if (!title) { toast('Title is required', true); return; }
  const btn = document.getElementById('create-col-btn');
  btn.innerHTML = '<div class="spinner" style="width:18px;height:18px;border-width:2px;"></div>';
  btn.disabled = true;
  const body = {
    title,
    description: document.getElementById('c-desc').value.trim() || null,
    icon: document.getElementById('c-icon').value.trim() || 'folder',
    theme: document.getElementById('c-theme').value,
  };
  const res = await api('POST', '/api/collections', body);
  if (res.ok) {
    closeModal();
    toast('Collection created!');
    navigate('#collection/' + res.data.id);
  } else {
    toast(res.data?.detail || 'Failed to create', true);
    btn.textContent = 'Create Collection';
    btn.disabled = false;
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// CONTENT DETAIL PAGE
// ═══════════════════════════════════════════════════════════════════════════
let _contentDetailTab = 'summary';

async function renderContentDetail(el, id) {
  if (!id) { navigate('#library'); return; }
  const [res, tagRes] = await Promise.all([
    api('GET', `/api/content/${id}`),
    api('GET', `/api/content/${id}/tags`),
  ]);
  if (!res.ok) { el.innerHTML = `<div class="text-center py-16 fade-in"><span class="material-icons-round text-5xl text-muted/30 mb-3">error</span><p class="text-muted">Content not found</p></div>`; return; }
  const c = res.data;
  const tags = tagRes.ok && tagRes.data.content_tags ? tagRes.data.content_tags.map(t => t.tags || t) : [];

  const tabClass = (t) => _contentDetailTab === t
    ? 'bg-accent text-white shadow-sm'
    : 'text-muted hover:text-heading';

  el.innerHTML = `
    <div class="slide-in-right">
      <!-- Sticky Header -->
      <div class="flex items-center gap-3 mb-4">
        <button onclick="navigate('#library')" class="p-2 rounded-xl hover:bg-surface-hover transition-colors" aria-label="Back to library">
          <span class="material-icons-round text-xl text-muted">arrow_back</span>
        </button>
        <h1 class="text-lg font-bold text-heading truncate flex-1">${esc(c.title || 'Untitled')}</h1>
        <button onclick="openContentActions('${c.id}')" class="p-2 rounded-xl hover:bg-surface-hover transition-colors" aria-label="More actions">
          <span class="material-icons-round text-xl text-muted">more_vert</span>
        </button>
      </div>

      <!-- Hero Image -->
      ${c.thumbnail_url ? `<img src="${esc(c.thumbnail_url)}" alt="" class="w-full h-48 object-cover rounded-2xl mb-4 shadow-card" onerror="this.style.display='none'" />` : ''}

      <!-- Title & URL -->
      <div class="mb-4">
        <h2 class="text-xl font-bold text-heading leading-snug">${esc(c.title || 'Untitled')}</h2>
        <a href="${esc(c.url)}" target="_blank" rel="noopener" class="text-accent text-sm hover:underline break-all mt-1 inline-block">${esc(truncate(c.url, 60))}</a>
      </div>

      <!-- Badges -->
      <div class="flex items-center gap-2 flex-wrap mb-5">
        ${badge(c.platform, 'blue')}
        ${badge(c.content_type, 'purple')}
        ${badge(c.ai_category, 'emerald')}
        ${c.ai_processed
          ? '<span class="text-success text-xs flex items-center gap-0.5"><span class="material-icons-round text-sm">check_circle</span>AI Processed</span>'
          : '<span class="text-muted text-xs">Not AI processed</span>'}
      </div>

      <!-- Content Tabs -->
      <div class="flex bg-surface rounded-xl p-1 gap-1 mb-4 shadow-card" role="tablist">
        <button onclick="switchContentTab('summary','${c.id}')" role="tab" class="flex-1 py-2 text-xs font-medium rounded-lg transition-all duration-200 ${tabClass('summary')}">Summary</button>
        <button onclick="switchContentTab('tags','${c.id}')" role="tab" class="flex-1 py-2 text-xs font-medium rounded-lg transition-all duration-200 ${tabClass('tags')}">Tags</button>
        <button onclick="switchContentTab('info','${c.id}')" role="tab" class="flex-1 py-2 text-xs font-medium rounded-lg transition-all duration-200 ${tabClass('info')}">Info</button>
      </div>

      <div id="content-tab-body" class="mb-6">
        ${renderContentTabBody(c, tags)}
      </div>

      <!-- Primary Action -->
      ${!c.ai_processed ? `
        <button onclick="processWithAI('${c.id}')" id="ai-btn" class="w-full flex items-center justify-center gap-2 bg-accent hover:bg-accent-hover text-white font-semibold py-3.5 rounded-xl transition-colors active:scale-[0.97] mb-3 shadow-card">
          <span class="material-icons-round text-lg">auto_awesome</span> Process with AI
        </button>` : ''}

      <button onclick="openAddToCollectionModal('${c.id}')" class="w-full flex items-center justify-center gap-2 bg-surface hover:bg-surface-hover border border-border text-heading font-semibold py-3 rounded-xl transition-colors active:scale-[0.97] shadow-card">
        <span class="material-icons-round text-lg">folder</span> Add to Collection
      </button>
    </div>`;
}

function renderContentTabBody(c, tags) {
  if (_contentDetailTab === 'summary') {
    return c.ai_summary
      ? `<div class="bg-surface rounded-2xl p-5 shadow-card border border-border">
          <div class="flex items-center gap-2 mb-3">
            <span class="material-icons-round text-base text-accent">auto_awesome</span>
            <h3 class="text-xs font-semibold text-accent uppercase tracking-wide">AI Summary</h3>
          </div>
          <p class="text-body text-sm leading-relaxed">${esc(c.ai_summary)}</p>
        </div>`
      : `<div class="text-center py-8"><p class="text-muted text-sm">No AI summary available yet</p>${!c.ai_processed ? '<p class="text-muted text-xs mt-1">Process with AI to generate a summary</p>' : ''}</div>`;
  }
  if (_contentDetailTab === 'tags') {
    return tags.length > 0
      ? `<div class="flex flex-wrap gap-2">${tags.map(t => `<button onclick="navigate('#search');setTimeout(()=>{document.getElementById('search-input').value='${esc(t.name||t.slug||'')}';setSearchType('tag');doSearch()},100)" class="px-3 py-1.5 rounded-xl bg-surface border border-border text-sm text-body hover:border-accent hover:text-accent transition-colors">${esc(t.name || t.slug || '')}</button>`).join('')}</div>`
      : '<div class="text-center py-8"><p class="text-muted text-sm">No tags yet</p></div>';
  }
  // info tab
  return `
    <div class="bg-surface rounded-2xl p-5 shadow-card border border-border space-y-3">
      ${c.description ? `<div><label class="text-xs text-muted font-medium block mb-1">Description</label><p class="text-body text-sm">${esc(c.description)}</p></div>` : ''}
      <div><label class="text-xs text-muted font-medium block mb-1">URL</label><a href="${esc(c.url)}" target="_blank" rel="noopener" class="text-accent text-sm hover:underline break-all">${esc(c.url)}</a></div>
      <div class="grid grid-cols-2 gap-3">
        <div><label class="text-xs text-muted font-medium block mb-1">Platform</label><p class="text-body text-sm flex items-center gap-1"><span class="material-icons-round text-base">${platformIcon(c.platform)}</span>${esc(c.platform || 'Unknown')}</p></div>
        <div><label class="text-xs text-muted font-medium block mb-1">Type</label><p class="text-body text-sm">${esc(c.content_type || 'Unknown')}</p></div>
      </div>
      <div><label class="text-xs text-muted font-medium block mb-1">Status</label><p class="text-sm ${c.ai_processed ? 'text-success' : 'text-muted'}">${c.ai_processed ? 'AI Processed' : 'Not processed'}</p></div>
    </div>`;
}

function switchContentTab(tab, contentId) {
  _contentDetailTab = tab;
  // Re-render just the tab body
  renderContentDetail(document.getElementById('page'), contentId);
}

function openContentActions(contentId) {
  openModal(`
    <h2 class="text-lg font-bold text-heading mb-4">Actions</h2>
    <div class="space-y-2">
      <button onclick="closeModal();openEditContentModal('${contentId}')" class="w-full flex items-center gap-3 px-4 py-3.5 rounded-xl hover:bg-surface-hover transition-colors text-left">
        <span class="material-icons-round text-xl text-muted">edit</span>
        <span class="text-heading text-sm font-medium">Edit Content</span>
      </button>
      <button onclick="closeModal();openAddToCollectionModal('${contentId}')" class="w-full flex items-center gap-3 px-4 py-3.5 rounded-xl hover:bg-surface-hover transition-colors text-left">
        <span class="material-icons-round text-xl text-muted">folder</span>
        <span class="text-heading text-sm font-medium">Add to Collection</span>
      </button>
      <button onclick="closeModal();deleteContent('${contentId}')" class="w-full flex items-center gap-3 px-4 py-3.5 rounded-xl hover:bg-danger/10 transition-colors text-left">
        <span class="material-icons-round text-xl text-danger">delete</span>
        <span class="text-danger text-sm font-medium">Delete</span>
      </button>
    </div>
  `);
}

async function processWithAI(contentId) {
  const btn = document.getElementById('ai-btn');
  btn.innerHTML = '<div class="spinner" style="width:18px;height:18px;border-width:2px;"></div> Processing...';
  btn.disabled = true;
  const res = await api('POST', '/api/ai/process-content', { content_id: contentId });
  if (res.ok) {
    toast('AI processing complete!');
    _contentDetailTab = 'summary';
    await renderContentDetail(document.getElementById('page'), contentId);
  } else {
    toast(res.data?.detail || 'AI processing failed', true);
    btn.innerHTML = '<span class="material-icons-round text-lg">auto_awesome</span> Process with AI';
    btn.disabled = false;
  }
}

async function openAddToCollectionModal(contentId) {
  const res = await api('GET', '/api/collections');
  const cols = res.ok ? (Array.isArray(res.data) ? res.data : []) : [];
  openModal(`
    <h2 class="text-lg font-bold text-heading mb-4">Add to Collection</h2>
    ${cols.length === 0 ? '<p class="text-muted text-sm">No collections yet. Create one first.</p>' : `
      <div class="space-y-2">
        ${cols.map(c => `
          <button onclick="addToCollection('${c.id}','${contentId}')" class="w-full text-left bg-bg hover:bg-surface-hover border border-border rounded-xl px-4 py-3.5 transition-colors">
            <div class="flex items-center gap-3">
              <span class="material-icons-round text-xl text-accent">${esc(c.icon || 'folder')}</span>
              <div><p class="text-heading text-sm font-medium">${esc(c.title)}</p><p class="text-muted text-xs">${c.item_count} items</p></div>
            </div>
          </button>`).join('')}
      </div>`}
  `);
}

async function addToCollection(collectionId, contentId) {
  const res = await api('POST', `/api/collections/${collectionId}/items`, { content_id: contentId });
  if (res.ok) { closeModal(); toast('Added to collection!'); }
  else toast(res.data?.detail || 'Failed to add', true);
}

async function openEditContentModal(contentId) {
  const res = await api('GET', `/api/content/${contentId}`);
  if (!res.ok) return;
  const c = res.data;
  openModal(`
    <h2 class="text-lg font-bold text-heading mb-4">Edit Content</h2>
    <div class="space-y-4">
      <div>
        <label for="e-title" class="text-xs text-muted font-medium mb-1.5 block">Title</label>
        <input id="e-title" value="${esc(c.title || '')}" class="w-full bg-bg border border-border rounded-xl px-4 py-3 text-sm text-heading focus:outline-none focus:border-accent focus:ring-1 focus:ring-accent/30" />
      </div>
      <div>
        <label for="e-desc" class="text-xs text-muted font-medium mb-1.5 block">Description</label>
        <textarea id="e-desc" rows="3" class="w-full bg-bg border border-border rounded-xl px-4 py-3 text-sm text-heading focus:outline-none focus:border-accent focus:ring-1 focus:ring-accent/30 resize-none">${esc(c.description || '')}</textarea>
      </div>
      <div>
        <label for="e-url" class="text-xs text-muted font-medium mb-1.5 block">URL</label>
        <input id="e-url" value="${esc(c.url || '')}" class="w-full bg-bg border border-border rounded-xl px-4 py-3 text-sm text-heading focus:outline-none focus:border-accent focus:ring-1 focus:ring-accent/30" />
      </div>
      <button onclick="doEditContent('${contentId}')" id="edit-btn" class="w-full bg-accent hover:bg-accent-hover text-white font-semibold py-3.5 rounded-xl transition-colors active:scale-[0.97]">Save Changes</button>
    </div>
  `);
}

async function doEditContent(contentId) {
  const btn = document.getElementById('edit-btn');
  btn.innerHTML = '<div class="spinner" style="width:18px;height:18px;border-width:2px;"></div>';
  btn.disabled = true;
  const body = {
    title: document.getElementById('e-title').value.trim() || null,
    description: document.getElementById('e-desc').value.trim() || null,
    url: document.getElementById('e-url').value.trim() || null,
  };
  const res = await api('PATCH', `/api/content/${contentId}`, body);
  if (res.ok) {
    closeModal();
    toast('Content updated!');
    await renderContentDetail(document.getElementById('page'), contentId);
  } else {
    toast(res.data?.detail || 'Failed to update', true);
    btn.textContent = 'Save Changes';
    btn.disabled = false;
  }
}

async function deleteContent(contentId) {
  const ok = await customConfirm('Delete Content', 'This action cannot be undone. Are you sure?', 'Delete', true);
  if (!ok) return;
  const res = await api('DELETE', `/api/content/${contentId}`);
  if (res.ok) { toast('Deleted!'); navigate('#library'); }
  else toast(res.data?.detail || 'Failed to delete', true);
}

// ═══════════════════════════════════════════════════════════════════════════
// COLLECTION DETAIL PAGE
// ═══════════════════════════════════════════════════════════════════════════
async function renderCollectionDetail(el, id) {
  if (!id) { navigate('#library/collections'); return; }
  const [colRes, itemsRes] = await Promise.all([
    api('GET', `/api/collections/${id}`),
    api('GET', `/api/collections/${id}/items`),
  ]);
  if (!colRes.ok) { el.innerHTML = '<div class="text-center py-16 fade-in"><span class="material-icons-round text-5xl text-muted/30 mb-3">error</span><p class="text-muted">Collection not found</p></div>'; return; }
  const c = colRes.data;
  const items = itemsRes.ok ? (Array.isArray(itemsRes.data) ? itemsRes.data : []) : [];

  el.innerHTML = `
    <div class="slide-in-right">
      <!-- Header -->
      <div class="flex items-center gap-3 mb-5">
        <button onclick="navigate('#library/collections')" class="p-2 rounded-xl hover:bg-surface-hover transition-colors" aria-label="Back to collections">
          <span class="material-icons-round text-xl text-muted">arrow_back</span>
        </button>
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-2">
            <span class="material-icons-round text-2xl text-accent">${esc(c.icon || 'folder')}</span>
            <h1 class="text-lg font-bold text-heading truncate">${esc(c.title)}</h1>
          </div>
          <p class="text-muted text-xs mt-0.5">${c.item_count} items ${c.is_shared ? '&middot; Shared' : ''}</p>
        </div>
        <div class="flex gap-1">
          <button onclick="openEditCollectionModal('${c.id}')" class="p-2 rounded-xl hover:bg-surface-hover transition-colors" aria-label="Edit collection">
            <span class="material-icons-round text-lg text-muted">edit</span>
          </button>
          <button onclick="deleteCollection('${c.id}')" class="p-2 rounded-xl hover:bg-danger/10 transition-colors" aria-label="Delete collection">
            <span class="material-icons-round text-lg text-danger">delete</span>
          </button>
        </div>
      </div>

      ${c.description ? `<p class="text-muted text-sm mb-4">${esc(c.description)}</p>` : ''}

      <button onclick="openAddContentToCollectionModal('${c.id}')" class="w-full flex items-center justify-center gap-2 bg-surface hover:bg-surface-hover border border-border text-heading text-sm font-medium py-3 rounded-xl transition-colors mb-4 shadow-card active:scale-[0.97]">
        <span class="material-icons-round text-base">add</span> Add Content
      </button>

      ${items.length === 0 ? '<div class="text-center py-12"><p class="text-muted text-sm">No items in this collection</p></div>' : `
        <div class="space-y-2">
          ${items.map(item => {
            const ci = item.content || item;
            return `
            <div class="bg-surface rounded-xl p-3.5 flex items-center gap-3 hover:bg-surface-hover transition-colors shadow-card">
              <div class="flex-1 min-w-0 cursor-pointer" onclick="navigate('#content-detail/${ci.id || item.content_id}')">
                <p class="text-heading text-sm font-medium truncate">${esc(ci.title || ci.url || 'Untitled')}</p>
                <p class="text-muted text-xs truncate">${esc(ci.url || '')}</p>
              </div>
              <button onclick="removeFromCollection('${c.id}','${ci.id || item.content_id}')" class="p-1.5 rounded-lg hover:bg-danger/10 transition-colors" aria-label="Remove from collection">
                <span class="material-icons-round text-base text-danger">close</span>
              </button>
            </div>`;
          }).join('')}
        </div>`}
    </div>`;
}

async function openAddContentToCollectionModal(collectionId) {
  const res = await api('GET', '/api/content', null, { limit: 50 });
  const items = res.ok ? (Array.isArray(res.data) ? res.data : []) : [];
  openModal(`
    <h2 class="text-lg font-bold text-heading mb-4">Add Content</h2>
    ${items.length === 0 ? '<p class="text-muted text-sm">No content to add. Save some content first.</p>' : `
      <div class="space-y-2 max-h-96 overflow-y-auto no-scrollbar">
        ${items.map(c => `
          <button onclick="addToCollection('${collectionId}','${c.id}')" class="w-full text-left bg-bg hover:bg-surface-hover border border-border rounded-xl px-4 py-3 transition-colors">
            <p class="text-heading text-sm font-medium truncate">${esc(c.title || c.url)}</p>
            <p class="text-muted text-xs truncate">${esc(c.url)}</p>
          </button>`).join('')}
      </div>`}
  `);
}

async function removeFromCollection(collectionId, contentId) {
  const res = await api('DELETE', `/api/collections/${collectionId}/items/${contentId}`);
  if (res.ok) {
    toast('Removed from collection');
    await renderCollectionDetail(document.getElementById('page'), collectionId);
  } else toast(res.data?.detail || 'Failed to remove', true);
}

async function openEditCollectionModal(collectionId) {
  const res = await api('GET', `/api/collections/${collectionId}`);
  if (!res.ok) return;
  const c = res.data;
  openModal(`
    <h2 class="text-lg font-bold text-heading mb-4">Edit Collection</h2>
    <div class="space-y-4">
      <div>
        <label for="ec-title" class="text-xs text-muted font-medium mb-1.5 block">Title</label>
        <input id="ec-title" value="${esc(c.title)}" class="w-full bg-bg border border-border rounded-xl px-4 py-3 text-sm text-heading focus:outline-none focus:border-accent focus:ring-1 focus:ring-accent/30" />
      </div>
      <div>
        <label for="ec-desc" class="text-xs text-muted font-medium mb-1.5 block">Description</label>
        <textarea id="ec-desc" rows="2" class="w-full bg-bg border border-border rounded-xl px-4 py-3 text-sm text-heading focus:outline-none focus:border-accent focus:ring-1 focus:ring-accent/30 resize-none">${esc(c.description || '')}</textarea>
      </div>
      <label class="flex items-center gap-3 cursor-pointer">
        <input id="ec-shared" type="checkbox" ${c.is_shared ? 'checked' : ''} class="w-5 h-5 rounded-lg border-border text-accent focus:ring-accent" />
        <span class="text-sm text-heading font-medium">Share collection</span>
      </label>
      <button onclick="doEditCollection('${collectionId}')" id="edit-col-btn" class="w-full bg-accent hover:bg-accent-hover text-white font-semibold py-3.5 rounded-xl transition-colors active:scale-[0.97]">Save Changes</button>
    </div>
  `);
}

async function doEditCollection(collectionId) {
  const btn = document.getElementById('edit-col-btn');
  btn.innerHTML = '<div class="spinner" style="width:18px;height:18px;border-width:2px;"></div>';
  btn.disabled = true;
  const body = {
    title: document.getElementById('ec-title').value.trim() || null,
    description: document.getElementById('ec-desc').value.trim() || null,
    is_shared: document.getElementById('ec-shared').checked,
  };
  const res = await api('PATCH', `/api/collections/${collectionId}`, body);
  if (res.ok) {
    closeModal();
    toast('Collection updated!');
    await renderCollectionDetail(document.getElementById('page'), collectionId);
  } else {
    toast(res.data?.detail || 'Failed to update', true);
    btn.textContent = 'Save Changes';
    btn.disabled = false;
  }
}

async function deleteCollection(id) {
  const ok = await customConfirm('Delete Collection', 'This will remove the collection but not its content. Continue?', 'Delete', true);
  if (!ok) return;
  const res = await api('DELETE', `/api/collections/${id}`);
  if (res.ok) { toast('Deleted!'); navigate('#library/collections'); }
  else toast(res.data?.detail || 'Failed to delete', true);
}

// ═══════════════════════════════════════════════════════════════════════════
// GOALS PAGE
// ═══════════════════════════════════════════════════════════════════════════
let _goalsFilter = 'active';
let _showSuggestions = false;

async function renderGoals(el) {
  const [res, suggestionsRes] = await Promise.all([
    api('GET', '/api/goals', null, { status: _goalsFilter }),
    _goalsFilter === 'active' ? api('GET', '/api/goals/suggestions', null, { status: 'pending' }) : Promise.resolve({ ok: true, data: [] }),
  ]);
  const goals = res.ok ? (Array.isArray(res.data) ? res.data : []) : [];
  const suggestions = suggestionsRes.ok ? (Array.isArray(suggestionsRes.data) ? suggestionsRes.data : []) : [];
  const parentGoals = goals.filter(g => !g.parent_goal_id);
  const subGoalsByParent = {};
  goals.filter(g => g.parent_goal_id).forEach(g => {
    if (!subGoalsByParent[g.parent_goal_id]) subGoalsByParent[g.parent_goal_id] = [];
    subGoalsByParent[g.parent_goal_id].push(g);
  });

  // Calculate overall progress
  const allSteps = goals.flatMap(g => g.steps || []);
  const totalSteps = allSteps.length;
  const completedSteps = allSteps.filter(s => s.is_completed).length;
  const overallPercent = totalSteps > 0 ? Math.round((completedSteps / totalSteps) * 100) : 0;

  el.innerHTML = `
    <div class="fade-in">
      <!-- Header with Progress Ring -->
      <div class="flex items-center justify-between mb-5">
        <div class="flex items-center gap-4">
          <div class="relative">
            ${progressRing(overallPercent, 52, 4)}
            <span class="absolute inset-0 flex items-center justify-center text-xs font-bold text-heading">${overallPercent}%</span>
          </div>
          <div>
            <h1 class="text-xl font-bold text-heading">Goals</h1>
            <p class="text-muted text-xs">${goals.length} goal${goals.length !== 1 ? 's' : ''} &middot; ${completedSteps}/${totalSteps} steps</p>
          </div>
        </div>
        <button onclick="openGoalsMenu()" class="p-2 rounded-xl hover:bg-surface-hover transition-colors" aria-label="Goal actions">
          <span class="material-icons-round text-xl text-muted">more_vert</span>
        </button>
      </div>

      <!-- Filter Pills -->
      <div class="flex gap-2 mb-5" role="tablist" aria-label="Goal status filter">
        ${['active', 'completed', 'dismissed'].map(s => `
          <button onclick="setGoalsFilter('${s}')" role="tab" aria-selected="${_goalsFilter === s}" class="px-4 py-2 rounded-full text-xs font-semibold transition-all duration-200 ${_goalsFilter === s ? 'bg-accent text-white shadow-sm' : 'bg-surface text-muted hover:text-heading shadow-card'}">${s.charAt(0).toUpperCase() + s.slice(1)}</button>
        `).join('')}
      </div>

      <!-- Merge Suggestions Banner -->
      ${suggestions.length > 0 ? `
        <button onclick="toggleSuggestions()" class="w-full bg-purple-500/10 border border-purple-500/20 rounded-2xl p-4 mb-4 flex items-center gap-3 transition-all active:scale-[0.98]" aria-expanded="${_showSuggestions}">
          <div class="w-10 h-10 rounded-xl bg-purple-500/20 flex items-center justify-center flex-shrink-0">
            <span class="material-icons-round text-xl text-purple-400">merge_type</span>
          </div>
          <div class="flex-1 text-left">
            <p class="text-heading text-sm font-semibold">You have ${suggestions.length} merge suggestion${suggestions.length !== 1 ? 's' : ''}</p>
            <p class="text-muted text-xs">Tap to ${_showSuggestions ? 'hide' : 'review'}</p>
          </div>
          <span class="material-icons-round text-muted transition-transform ${_showSuggestions ? 'rotate-180' : ''}">${_showSuggestions ? 'expand_less' : 'expand_more'}</span>
        </button>
        ${_showSuggestions ? `<div class="space-y-3 mb-4">${suggestions.map(mergeSuggestionCard).join('')}</div>` : ''}
      ` : ''}

      <!-- Goals List -->
      ${parentGoals.length === 0 && suggestions.length === 0 ? `
        <div class="flex flex-col items-center justify-center py-16 text-center">
          <div class="w-20 h-20 rounded-3xl bg-accent/10 flex items-center justify-center mb-4">
            <span class="material-icons-round text-4xl text-accent/60">flag</span>
          </div>
          <p class="text-heading font-semibold mb-1">${_goalsFilter === 'active' ? 'No active goals yet' : 'No ' + _goalsFilter + ' goals'}</p>
          <p class="text-muted text-sm">Save more content and Zuno will detect your goals automatically</p>
        </div>` : `
        <div class="space-y-3">
          ${parentGoals.map(g => goalCard(g, subGoalsByParent[g.id] || [])).join('')}
        </div>`}
    </div>`;
}

function goalCard(goal, children = []) {
  const confidence = Math.round((goal.confidence || 0) * 100);
  const evidenceCount = (goal.evidence_content_ids || []).length;
  const hasChildren = children.length > 0;
  const steps = goal.steps || [];
  const stepsDone = steps.filter(s => s.is_completed).length;
  const stepsTotal = steps.length;
  const stepPercent = stepsTotal > 0 ? Math.round((stepsDone / stepsTotal) * 100) : 0;

  const statusBorder = { active: 'border-l-accent', completed: 'border-l-success', dismissed: 'border-l-muted' };
  const borderClass = statusBorder[goal.status] || 'border-l-accent';

  return `
    <article onclick="navigate('#goal-detail/${goal.id}')" class="bg-surface rounded-2xl p-4 shadow-card hover:shadow-elevated transition-all duration-200 cursor-pointer active:scale-[0.97] border-l-4 ${borderClass}">
      <div class="flex items-start gap-3">
        <div class="w-10 h-10 rounded-xl ${hasChildren ? 'bg-purple-500/15' : 'bg-accent/15'} flex items-center justify-center flex-shrink-0 mt-0.5">
          <span class="material-icons-round text-xl ${hasChildren ? 'text-purple-500' : 'text-accent'}">${hasChildren ? 'account_tree' : 'flag'}</span>
        </div>
        <div class="flex-1 min-w-0">
          <h3 class="font-semibold text-heading text-sm leading-snug line-clamp-2">${esc(goal.title)}</h3>
          <p class="text-muted text-xs mt-1 line-clamp-2">${esc(goal.description || '')}</p>

          <!-- Mini Progress Bar -->
          ${stepsTotal > 0 ? `
          <div class="mt-2.5 flex items-center gap-2">
            <div class="flex-1 h-1.5 bg-surface-hover rounded-full overflow-hidden">
              <div class="h-full ${hasChildren ? 'bg-purple-500' : 'bg-accent'} rounded-full transition-all duration-300" style="width:${stepPercent}%"></div>
            </div>
            <span class="text-muted text-[10px] flex-shrink-0">${stepsDone}/${stepsTotal}</span>
          </div>` : ''}

          <div class="flex items-center gap-3 mt-2">
            ${badge(goal.category, 'emerald')}
            <span class="text-muted text-[10px] flex items-center gap-0.5"><span class="material-icons-round text-xs">trending_up</span>${confidence}%</span>
            <span class="text-muted text-[10px] flex items-center gap-0.5"><span class="material-icons-round text-xs">link</span>${evidenceCount}</span>
            ${hasChildren ? `<span class="text-purple-400 text-[10px] flex items-center gap-0.5"><span class="material-icons-round text-xs">account_tree</span>${children.length}</span>` : ''}
          </div>
        </div>
      </div>
    </article>`;
}

function mergeSuggestionCard(suggestion) {
  const childCount = (suggestion.child_goal_ids || []).length;
  return `
    <div class="bg-purple-500/10 border border-purple-500/20 rounded-2xl p-4">
      <div class="flex items-start gap-3">
        <div class="w-10 h-10 rounded-xl bg-purple-500/20 flex items-center justify-center flex-shrink-0 mt-0.5">
          <span class="material-icons-round text-xl text-purple-400">merge_type</span>
        </div>
        <div class="flex-1 min-w-0">
          <span class="inline-block text-[10px] font-semibold uppercase tracking-wide text-purple-400 bg-purple-500/20 px-2 py-0.5 rounded-full mb-1.5">Merge Suggestion</span>
          <h3 class="font-semibold text-heading text-sm leading-snug">${esc(suggestion.suggested_parent_title)}</h3>
          <p class="text-muted text-xs mt-1 line-clamp-3">${esc(suggestion.ai_reasoning || suggestion.suggested_parent_description)}</p>
          <p class="text-purple-400/70 text-[10px] mt-1.5"><span class="material-icons-round text-xs align-middle">account_tree</span> Merges ${childCount} goal${childCount !== 1 ? 's' : ''}</p>
          <div class="flex items-center gap-2 mt-3">
            <button onclick="event.stopPropagation();acceptSuggestion('${suggestion.id}')" id="accept-${suggestion.id}" class="flex-1 bg-purple-500 hover:bg-purple-600 text-white text-xs font-semibold py-2.5 px-3 rounded-xl transition-colors active:scale-[0.97] flex items-center justify-center gap-1">
              <span class="material-icons-round text-sm">check</span> Accept
            </button>
            <button onclick="event.stopPropagation();dismissSuggestion('${suggestion.id}')" id="dismiss-${suggestion.id}" class="flex-1 bg-surface hover:bg-surface-hover text-muted text-xs font-semibold py-2.5 px-3 rounded-xl transition-colors active:scale-[0.97] border border-border flex items-center justify-center gap-1">
              <span class="material-icons-round text-sm">close</span> Dismiss
            </button>
          </div>
        </div>
      </div>
    </div>`;
}

function toggleSuggestions() {
  _showSuggestions = !_showSuggestions;
  renderGoals(document.getElementById('page'));
}

function openGoalsMenu() {
  openModal(`
    <h2 class="text-lg font-bold text-heading mb-4">Goal Actions</h2>
    <div class="space-y-2">
      <button onclick="closeModal();reanalyzeGoals()" class="w-full flex items-center gap-3 px-4 py-3.5 rounded-xl hover:bg-surface-hover transition-colors text-left">
        <span class="material-icons-round text-xl text-accent">refresh</span>
        <div><p class="text-heading text-sm font-medium">Reanalyze Goals</p><p class="text-muted text-xs">Re-scan content for new goals</p></div>
      </button>
      <button onclick="closeModal();triggerConsolidate()" class="w-full flex items-center gap-3 px-4 py-3.5 rounded-xl hover:bg-surface-hover transition-colors text-left">
        <span class="material-icons-round text-xl text-purple-400">merge_type</span>
        <div><p class="text-heading text-sm font-medium">Consolidate Goals</p><p class="text-muted text-xs">Find goals to merge together</p></div>
      </button>
    </div>
  `);
}

async function acceptSuggestion(id) {
  const btn = document.getElementById('accept-' + id);
  if (btn) { btn.innerHTML = '<div class="spinner" style="width:14px;height:14px;border-width:2px;"></div>'; btn.disabled = true; }
  const res = await api('POST', `/api/goals/suggestions/${id}/accept`);
  if (res.ok) { toast(res.data?.message || 'Goals merged!'); renderGoals(document.getElementById('page')); }
  else { toast(res.data?.detail || 'Failed to merge', true); if (btn) { btn.textContent = 'Accept'; btn.disabled = false; } }
}

async function dismissSuggestion(id) {
  const btn = document.getElementById('dismiss-' + id);
  if (btn) { btn.innerHTML = '<div class="spinner" style="width:14px;height:14px;border-width:2px;"></div>'; btn.disabled = true; }
  const res = await api('POST', `/api/goals/suggestions/${id}/dismiss`);
  if (res.ok) { toast('Suggestion dismissed'); renderGoals(document.getElementById('page')); }
  else { toast(res.data?.detail || 'Failed to dismiss', true); if (btn) { btn.textContent = 'Dismiss'; btn.disabled = false; } }
}

async function triggerConsolidate() {
  toast('Starting consolidation...');
  const res = await api('POST', '/api/goals/consolidate');
  if (res.ok) toast(res.data?.message || 'Consolidation started!');
  else toast(res.data?.detail || 'Consolidation failed', true);
}

async function reanalyzeGoals() {
  toast('Reanalyzing goals...');
  const res = await api('POST', '/api/goals/reanalyze');
  if (res.ok) toast(res.data?.message || 'Reanalysis started!');
  else toast(res.data?.detail || 'Reanalysis failed', true);
}

function setGoalsFilter(status) { _goalsFilter = status; renderGoals(document.getElementById('page')); }

// ═══════════════════════════════════════════════════════════════════════════
// GOAL DETAIL PAGE
// ═══════════════════════════════════════════════════════════════════════════
let _showCompletedSteps = false;

async function renderGoalDetail(el, id) {
  if (!id) { navigate('#goals'); return; }
  const res = await api('GET', `/api/goals/${id}`);
  if (!res.ok) { el.innerHTML = '<div class="text-center py-16 fade-in"><span class="material-icons-round text-5xl text-muted/30 mb-3">error</span><p class="text-muted">Goal not found</p></div>'; return; }
  const g = res.data;
  const steps = g.steps || [];
  const completedSteps = steps.filter(s => s.is_completed);
  const pendingSteps = steps.filter(s => !s.is_completed);
  const completedCount = completedSteps.length;
  const totalSteps = steps.length;
  const progressPercent = totalSteps > 0 ? Math.round((completedCount / totalSteps) * 100) : 0;
  const confidence = Math.round((g.confidence || 0) * 100);
  const evidenceCount = (g.evidence_content_ids || []).length;
  const children = g.children || [];
  const hasChildren = children.length > 0;
  const isChild = !!g.parent_goal_id;
  const ringColor = hasChildren ? '#a855f7' : '#6366f1';

  el.innerHTML = `
    <div class="slide-in-right">
      <!-- Header -->
      <div class="flex items-center gap-3 mb-4">
        <button onclick="navigate('${isChild ? '#goal-detail/' + g.parent_goal_id : '#goals'}')" class="p-2 rounded-xl hover:bg-surface-hover transition-colors" aria-label="${isChild ? 'Back to parent goal' : 'Back to goals'}">
          <span class="material-icons-round text-xl text-muted">arrow_back</span>
        </button>
        <h1 class="text-lg font-bold text-heading truncate flex-1">${isChild ? 'Sub-goal' : 'Goal'}</h1>
      </div>

      <!-- Progress Card -->
      <section class="bg-surface rounded-2xl p-5 mb-4 shadow-card border border-border">
        <div class="flex items-center gap-4 mb-4">
          <div class="relative flex-shrink-0">
            ${progressRing(progressPercent, 64, 5, ringColor)}
            <span class="absolute inset-0 flex items-center justify-center text-sm font-bold text-heading">${progressPercent}%</span>
          </div>
          <div class="flex-1 min-w-0">
            <h2 class="text-lg font-bold text-heading leading-snug">${esc(g.title)}</h2>
            <div class="flex items-center gap-2 mt-1 flex-wrap">
              ${badge(g.category, 'emerald')}
              ${badge(g.status, g.status === 'active' ? 'indigo' : g.status === 'completed' ? 'green' : 'gray')}
              ${hasChildren ? '<span class="inline-block px-2 py-0.5 rounded-full text-[11px] font-semibold bg-purple-500/15 text-purple-500">Parent</span>' : ''}
              ${isChild ? '<span class="inline-block px-2 py-0.5 rounded-full text-[11px] font-semibold bg-purple-500/15 text-purple-500">Sub-goal</span>' : ''}
            </div>
          </div>
        </div>
        <p class="text-body text-sm leading-relaxed">${esc(g.description)}</p>
        <div class="flex items-center gap-4 mt-4 text-xs text-muted">
          <span class="flex items-center gap-1"><span class="material-icons-round text-sm">trending_up</span>${confidence}% confidence</span>
          <span class="flex items-center gap-1"><span class="material-icons-round text-sm">link</span>${evidenceCount} sources</span>
          <span class="flex items-center gap-1"><span class="material-icons-round text-sm">checklist</span>${completedCount}/${totalSteps} steps</span>
        </div>
      </section>

      <!-- Sub-goals (horizontal scroll) -->
      ${hasChildren ? `
      <section class="mb-4" aria-label="Sub-goals">
        <h3 class="text-sm font-semibold text-heading mb-3 flex items-center gap-1.5">
          <span class="material-icons-round text-base text-purple-400">account_tree</span> Sub-goals
        </h3>
        <div class="flex gap-3 overflow-x-auto no-scrollbar pb-1">
          ${children.map(c => {
            const cConf = Math.round((c.confidence || 0) * 100);
            const cStatus = c.status || 'active';
            const cIcon = cStatus === 'completed' ? 'check_circle' : cStatus === 'dismissed' ? 'do_not_disturb_on' : 'flag';
            const cColor = cStatus === 'completed' ? 'text-success' : cStatus === 'dismissed' ? 'text-muted' : 'text-accent';
            return `
            <article onclick="navigate('#goal-detail/${c.id}')" class="flex-shrink-0 w-44 bg-surface rounded-xl p-3.5 shadow-card border border-border hover:shadow-elevated transition-all cursor-pointer active:scale-[0.97]">
              <div class="flex items-center gap-2 mb-2">
                <span class="material-icons-round text-lg ${cColor}">${cIcon}</span>
                <span class="text-[10px] text-muted">${cConf}%</span>
              </div>
              <h4 class="font-semibold text-heading text-xs leading-snug line-clamp-2">${esc(c.title)}</h4>
            </article>`;
          }).join('')}
        </div>
      </section>` : ''}

      <!-- Steps -->
      <section class="mb-4" aria-label="Goal steps">
        <h3 class="text-sm font-semibold text-heading mb-3">Steps</h3>
        ${totalSteps === 0 ? '<p class="text-muted text-sm text-center py-4">No steps yet</p>' : `
          <div class="space-y-2" id="goal-steps-list">
            ${pendingSteps.map(step => goalStepCard(step, id)).join('')}
            ${completedCount > 0 ? `
              <button onclick="toggleCompletedSteps('${id}')" class="w-full flex items-center justify-center gap-1.5 py-2.5 text-xs text-muted font-medium hover:text-heading transition-colors">
                <span class="material-icons-round text-sm">${_showCompletedSteps ? 'expand_less' : 'expand_more'}</span>
                ${completedCount} completed step${completedCount !== 1 ? 's' : ''}
              </button>
              ${_showCompletedSteps ? completedSteps.map(step => goalStepCard(step, id)).join('') : ''}
            ` : ''}
          </div>`}
      </section>

      ${g.ai_reasoning ? `
        <section class="bg-surface rounded-2xl p-5 mb-4 shadow-card border border-border">
          <div class="flex items-center gap-2 mb-2">
            <span class="material-icons-round text-base text-accent">auto_awesome</span>
            <h3 class="text-xs font-semibold text-accent uppercase tracking-wide">AI Reasoning</h3>
          </div>
          <p class="text-muted text-sm leading-relaxed">${esc(g.ai_reasoning)}</p>
        </section>` : ''}

      <!-- Actions -->
      <div class="space-y-2">
        ${g.status === 'active' ? `
          <button onclick="updateGoalStatus('${g.id}','completed')" class="w-full flex items-center justify-center gap-2 bg-success/10 hover:bg-success/20 text-success font-semibold py-3.5 rounded-xl transition-colors active:scale-[0.97]">
            <span class="material-icons-round text-lg">check_circle</span> Mark Complete
          </button>
          <button onclick="updateGoalStatus('${g.id}','dismissed')" class="w-full flex items-center justify-center gap-2 bg-surface hover:bg-surface-hover border border-border text-muted font-medium py-3 rounded-xl transition-colors active:scale-[0.97]">
            <span class="material-icons-round text-lg">do_not_disturb_on</span> Dismiss Goal
          </button>` : `
          <button onclick="updateGoalStatus('${g.id}','active')" class="w-full flex items-center justify-center gap-2 bg-accent/10 hover:bg-accent/20 text-accent font-semibold py-3.5 rounded-xl transition-colors active:scale-[0.97]">
            <span class="material-icons-round text-lg">flag</span> Reactivate
          </button>`}
        <button onclick="deleteGoal('${g.id}')" class="w-full flex items-center justify-center gap-2 bg-surface hover:bg-danger/10 border border-border text-danger font-medium py-3 rounded-xl transition-colors active:scale-[0.97]">
          <span class="material-icons-round text-lg">delete</span> Delete Goal
        </button>
      </div>
    </div>`;
}

function goalStepCard(step, goalId) {
  const sourceCount = (step.source_content_ids || []).length;
  return `
    <div class="bg-surface rounded-xl p-3.5 flex items-start gap-3 transition-all duration-200 shadow-card ${step.is_completed ? 'opacity-60' : ''}">
      <button onclick="event.stopPropagation();toggleGoalStep('${goalId}','${step.id}',${!step.is_completed})" class="mt-0.5 flex-shrink-0 w-6 h-6 rounded-lg border-2 ${step.is_completed ? 'bg-accent border-accent check-bounce' : 'border-border hover:border-accent'} flex items-center justify-center transition-all" aria-label="${step.is_completed ? 'Mark incomplete' : 'Mark complete'}">
        ${step.is_completed ? '<span class="material-icons-round text-sm text-white">check</span>' : ''}
      </button>
      <div class="flex-1 min-w-0">
        <p class="text-heading text-sm font-medium leading-snug ${step.is_completed ? 'line-through' : ''}">${esc(step.title)}</p>
        ${step.description ? `<p class="text-muted text-xs mt-1 leading-relaxed">${esc(step.description)}</p>` : ''}
        <div class="flex items-center gap-2 mt-1.5">
          <span class="text-muted text-[10px]">Step ${step.step_index + 1}</span>
          ${sourceCount > 0 ? `<span class="text-muted text-[10px] flex items-center gap-0.5"><span class="material-icons-round text-[10px]">link</span>${sourceCount}</span>` : ''}
          ${step.is_completed && step.completed_at ? '<span class="text-success text-[10px]">Done</span>' : ''}
        </div>
      </div>
    </div>`;
}

function toggleCompletedSteps(goalId) {
  _showCompletedSteps = !_showCompletedSteps;
  renderGoalDetail(document.getElementById('page'), goalId);
}

async function toggleGoalStep(goalId, stepId, newValue) {
  const res = await api('PATCH', `/api/goals/${goalId}/steps/${stepId}`, { is_completed: newValue });
  if (res.ok) await renderGoalDetail(document.getElementById('page'), goalId);
  else toast(res.data?.detail || 'Failed to update step', true);
}

async function updateGoalStatus(goalId, status) {
  const res = await api('PATCH', `/api/goals/${goalId}`, { status });
  if (res.ok) {
    toast(`Goal ${status === 'completed' ? 'completed' : status === 'dismissed' ? 'dismissed' : 'reactivated'}!`);
    await renderGoalDetail(document.getElementById('page'), goalId);
  } else toast(res.data?.detail || 'Failed to update goal', true);
}

async function deleteGoal(goalId) {
  const ok = await customConfirm('Delete Goal', 'This will delete the goal and all its steps. Continue?', 'Delete', true);
  if (!ok) return;
  const res = await api('DELETE', `/api/goals/${goalId}`);
  if (res.ok) { toast('Goal deleted'); navigate('#goals'); }
  else toast(res.data?.detail || 'Failed to delete', true);
}

// ═══════════════════════════════════════════════════════════════════════════
// SEARCH PAGE
// ═══════════════════════════════════════════════════════════════════════════
let _searchType = 'fts';

async function renderSearch(el) {
  const tagsRes = await api('GET', '/api/tags/popular');
  const tags = tagsRes.ok ? (Array.isArray(tagsRes.data) ? tagsRes.data : []) : [];
  const recent = getRecentSearches();

  el.innerHTML = `
    <div class="fade-in">
      <!-- Search Input -->
      <div class="flex gap-2 mb-3">
        <div class="flex-1 relative">
          <input id="search-input" type="text" placeholder="Search your content..." class="w-full bg-surface border border-border rounded-xl pl-11 pr-10 py-3.5 text-sm text-heading placeholder-muted/50 focus:outline-none focus:border-accent focus:ring-1 focus:ring-accent/30 shadow-card" onkeydown="if(event.key==='Enter')doSearch()" autofocus aria-label="Search input" />
          <span class="material-icons-round text-xl text-muted absolute left-3.5 top-1/2 -translate-y-1/2">search</span>
          <button onclick="document.getElementById('search-input').value='';document.getElementById('search-results').innerHTML=''" class="absolute right-3 top-1/2 -translate-y-1/2 p-0.5 rounded-md hover:bg-surface-hover transition-colors" aria-label="Clear search">
            <span class="material-icons-round text-lg text-muted">close</span>
          </button>
        </div>
      </div>

      <!-- Search Type Tabs -->
      <div class="flex gap-2 mb-5" role="tablist" aria-label="Search type">
        <button onclick="setSearchType('fts')" id="st-fts" role="tab" class="search-type px-4 py-2 rounded-full text-xs font-semibold transition-all duration-200 ${_searchType === 'fts' ? 'bg-accent text-white shadow-sm' : 'bg-surface text-muted shadow-card hover:text-heading'}">Full-text</button>
        <button onclick="setSearchType('hybrid')" id="st-hybrid" role="tab" class="search-type px-4 py-2 rounded-full text-xs font-semibold transition-all duration-200 ${_searchType === 'hybrid' ? 'bg-accent text-white shadow-sm' : 'bg-surface text-muted shadow-card hover:text-heading'}">Hybrid</button>
        <button onclick="setSearchType('tag')" id="st-tag" role="tab" class="search-type px-4 py-2 rounded-full text-xs font-semibold transition-all duration-200 ${_searchType === 'tag' ? 'bg-accent text-white shadow-sm' : 'bg-surface text-muted shadow-card hover:text-heading'}">By Tag</button>
      </div>

      ${recent.length > 0 ? `
        <section class="mb-5" aria-label="Recent searches">
          <h3 class="text-xs font-semibold text-muted uppercase tracking-wide mb-2">Recent</h3>
          <div class="flex flex-wrap gap-1.5">
            ${recent.map(s => `<button onclick="document.getElementById('search-input').value='${esc(s)}';doSearch()" class="px-3 py-1.5 rounded-lg bg-surface border border-border text-xs text-body hover:border-accent transition-colors flex items-center gap-1"><span class="material-icons-round text-xs text-muted">history</span>${esc(s)}</button>`).join('')}
          </div>
        </section>` : ''}

      ${tags.length > 0 ? `
        <section class="mb-5" aria-label="Popular tags">
          <h3 class="text-xs font-semibold text-muted uppercase tracking-wide mb-2">Popular Tags</h3>
          <div class="flex flex-wrap gap-1.5">
            ${tags.map(t => `<button onclick="searchByTag('${esc(t.slug)}')" class="px-3 py-1.5 rounded-lg bg-surface border border-border text-xs text-body hover:border-accent transition-colors">${esc(t.name)} <span class="text-muted">${t.count || t.usage_count || ''}</span></button>`).join('')}
          </div>
        </section>` : ''}

      <div id="search-results" aria-live="polite"></div>
    </div>`;
}

function setSearchType(type) {
  _searchType = type;
  document.querySelectorAll('.search-type').forEach(b => {
    const active = b.id === 'st-' + type;
    b.className = `search-type px-4 py-2 rounded-full text-xs font-semibold transition-all duration-200 ${active ? 'bg-accent text-white shadow-sm' : 'bg-surface text-muted shadow-card hover:text-heading'}`;
  });
}

async function doSearch() {
  const q = document.getElementById('search-input').value.trim();
  if (!q) return;
  addRecentSearch(q);

  const resultsEl = document.getElementById('search-results');
  resultsEl.innerHTML = skeletonCards(2);

  let res;
  if (_searchType === 'hybrid') res = await api('GET', '/api/search/hybrid', null, { q, limit: 20 });
  else if (_searchType === 'tag') res = await api('GET', `/api/search/tag/${encodeURIComponent(q)}`, null, { limit: 20 });
  else res = await api('GET', '/api/search', null, { q, limit: 20 });

  const items = res.ok ? (Array.isArray(res.data) ? res.data : []) : [];
  if (!res.ok) {
    resultsEl.innerHTML = `<div class="bg-danger/10 rounded-xl p-4 text-center"><p class="text-danger text-sm">${esc(res.data?.detail || 'Search failed')}</p></div>`;
    return;
  }

  resultsEl.innerHTML = items.length === 0
    ? '<div class="text-center py-12"><span class="material-icons-round text-4xl text-muted/30 mb-2">search_off</span><p class="text-muted text-sm">No results found</p></div>'
    : `<p class="text-muted text-xs mb-3">${items.length} result${items.length !== 1 ? 's' : ''}</p>
       <div class="space-y-3">${items.map(i => contentCardHtml(i)).join('')}</div>`;
}

function searchByTag(slug) {
  setSearchType('tag');
  document.getElementById('search-input').value = slug;
  doSearch();
}

// ═══════════════════════════════════════════════════════════════════════════
// KNOWLEDGE Q&A PAGE
// ═══════════════════════════════════════════════════════════════════════════
let _knowledgeHistory = [];
const _suggestedQuestions = [
  'What topics appear most in my saved content?',
  'Summarize my most recent saves',
  'What are the key takeaways from my articles?',
  'How are my saved items connected?',
];

async function renderKnowledge(el) {
  const statsRes = await api('GET', '/api/knowledge/stats');
  const stats = statsRes.ok ? statsRes.data : null;

  el.innerHTML = `
    <div class="fade-in flex flex-col" style="height: calc(100dvh - 160px);">
      <!-- Header -->
      <div class="flex items-center justify-between mb-4">
        <div>
          <h1 class="text-xl font-bold text-heading">Knowledge Q&A</h1>
          ${stats ? `<p class="text-muted text-xs mt-0.5">${stats.total_chunks || stats.chunks || 0} chunks indexed</p>` : ''}
        </div>
        <button onclick="openKnowledgeSettings()" class="p-2 rounded-xl hover:bg-surface-hover transition-colors" aria-label="Knowledge settings">
          <span class="material-icons-round text-xl text-muted">settings</span>
        </button>
      </div>

      <!-- Chat Area -->
      <div id="knowledge-chat" class="flex-1 overflow-y-auto no-scrollbar space-y-4 mb-4" role="log" aria-label="Chat messages">
        ${_knowledgeHistory.length === 0 ? `
          <div class="flex flex-col items-center justify-center h-full text-center px-4">
            <div class="w-20 h-20 rounded-3xl bg-accent/10 flex items-center justify-center mb-4">
              <span class="material-icons-round text-4xl text-accent/60">psychology</span>
            </div>
            <p class="text-heading font-semibold mb-1">Ask anything about your content</p>
            <p class="text-muted text-sm mb-5">Powered by RAG over your knowledge base</p>
            <div class="flex flex-wrap gap-2 justify-center">
              ${_suggestedQuestions.map(q => `
                <button onclick="askSuggested(this.textContent)" class="px-3 py-2 rounded-xl bg-surface border border-border text-xs text-body hover:border-accent hover:text-accent transition-colors shadow-card">${q}</button>
              `).join('')}
            </div>
          </div>` : _knowledgeHistory.map(renderKnowledgeMessage).join('')}
      </div>

      <!-- Input -->
      <div class="flex gap-2">
        <input id="knowledge-input" type="text" placeholder="Ask a question..." class="flex-1 bg-surface border border-border rounded-xl px-4 py-3.5 text-sm text-heading placeholder-muted/50 focus:outline-none focus:border-accent focus:ring-1 focus:ring-accent/30 shadow-card" onkeydown="if(event.key==='Enter')doAsk()" aria-label="Question input" />
        <button onclick="doAsk()" class="bg-accent hover:bg-accent-hover text-white px-4 rounded-xl transition-colors active:scale-95 shadow-card" aria-label="Send question">
          <span class="material-icons-round text-lg">send</span>
        </button>
      </div>
    </div>`;

  const chat = document.getElementById('knowledge-chat');
  chat.scrollTop = chat.scrollHeight;
}

function renderKnowledgeMessage(msg) {
  if (msg.role === 'user') {
    return `<div class="flex justify-end"><div class="bg-accent/20 text-heading rounded-2xl rounded-br-md px-4 py-3 max-w-[80%] text-sm">${esc(msg.text)}</div></div>`;
  }
  return `
    <div class="flex justify-start">
      <div class="bg-surface border border-border rounded-2xl rounded-bl-md px-4 py-3.5 max-w-[90%] shadow-card">
        <p class="text-body text-sm leading-relaxed whitespace-pre-wrap">${esc(msg.text)}</p>
        ${msg.sources && msg.sources.length > 0 ? `
          <div class="mt-3 pt-3 border-t border-border">
            <p class="text-muted text-[10px] uppercase tracking-wide font-semibold mb-2">Sources</p>
            <div class="space-y-1.5">
              ${msg.sources.map(s => `
                <div class="bg-bg rounded-xl px-3 py-2.5 cursor-pointer hover:bg-surface-hover transition-colors" onclick="navigate('#content-detail/${s.content_id}')">
                  <p class="text-heading text-xs font-medium line-clamp-1">${esc(s.title || s.url || s.content_id)}</p>
                  ${s.chunk_text ? `<p class="text-muted text-[11px] line-clamp-2 mt-0.5">${esc(truncate(s.chunk_text, 100))}</p>` : ''}
                </div>`).join('')}
            </div>
          </div>` : ''}
      </div>
    </div>`;
}

function askSuggested(q) {
  document.getElementById('knowledge-input').value = q;
  doAsk();
}

async function doAsk() {
  const input = document.getElementById('knowledge-input');
  const q = input.value.trim();
  if (!q) return;
  input.value = '';

  _knowledgeHistory.push({ role: 'user', text: q });
  const chat = document.getElementById('knowledge-chat');
  if (_knowledgeHistory.length === 1) chat.innerHTML = '';
  chat.innerHTML += renderKnowledgeMessage({ role: 'user', text: q });

  // Typing indicator
  chat.innerHTML += `<div id="typing" class="flex justify-start"><div class="bg-surface border border-border rounded-2xl rounded-bl-md px-5 py-4 shadow-card"><div class="flex gap-1.5"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></div></div></div>`;
  chat.scrollTop = chat.scrollHeight;

  const res = await api('POST', '/api/knowledge/ask', { query: q, include_sources: true });
  document.getElementById('typing')?.remove();

  const msg = res.ok
    ? { role: 'assistant', text: res.data.answer, sources: res.data.sources || [] }
    : { role: 'assistant', text: `Error: ${res.data?.detail || 'Failed to get answer'}`, sources: [] };
  _knowledgeHistory.push(msg);
  chat.innerHTML += renderKnowledgeMessage(msg);
  chat.scrollTop = chat.scrollHeight;
}

function openKnowledgeSettings() {
  openModal(`
    <h2 class="text-lg font-bold text-heading mb-4">Knowledge Settings</h2>
    <div class="space-y-2">
      <button onclick="closeModal();doReindex()" class="w-full flex items-center gap-3 px-4 py-3.5 rounded-xl hover:bg-surface-hover transition-colors text-left">
        <span class="material-icons-round text-xl text-accent">refresh</span>
        <div><p class="text-heading text-sm font-medium">Reindex Content</p><p class="text-muted text-xs">Rebuild the knowledge base index</p></div>
      </button>
      <button onclick="closeModal();_knowledgeHistory=[];renderKnowledge(document.getElementById('page'))" class="w-full flex items-center gap-3 px-4 py-3.5 rounded-xl hover:bg-surface-hover transition-colors text-left">
        <span class="material-icons-round text-xl text-muted">delete_sweep</span>
        <div><p class="text-heading text-sm font-medium">Clear Chat</p><p class="text-muted text-xs">Remove conversation history</p></div>
      </button>
    </div>
  `);
}

async function doReindex() {
  toast('Reindexing...');
  const res = await api('POST', '/api/knowledge/reindex', {});
  if (res.ok) toast(`Reindexed: ${res.data.content_processed} items, ${res.data.chunks_created} chunks`);
  else toast(res.data?.detail || 'Reindex failed', true);
}

// ═══════════════════════════════════════════════════════════════════════════
// PROFILE PAGE (includes Admin / Developer Tools)
// ═══════════════════════════════════════════════════════════════════════════
async function renderProfile(el) {
  const [profileRes, prefRes] = await Promise.all([
    api('GET', '/api/profile'),
    api('GET', '/api/user-preferences'),
  ]);
  const p = profileRes.ok ? profileRes.data : {};
  const pref = prefRes.ok ? prefRes.data : {};
  const theme = getTheme();

  el.innerHTML = `
    <div class="fade-in">
      <!-- Avatar Hero -->
      <section class="bg-surface rounded-2xl p-5 mb-4 shadow-card border border-border" aria-label="Account info">
        <div class="flex items-center gap-4 mb-5">
          <div class="w-16 h-16 rounded-2xl bg-accent/15 flex items-center justify-center overflow-hidden flex-shrink-0">
            ${p.avatar_url ? `<img src="${esc(p.avatar_url)}" alt="Avatar" class="w-full h-full object-cover" onerror="this.style.display='none'"/>` : `<span class="material-icons-round text-3xl text-accent">person</span>`}
          </div>
          <div>
            <h1 class="text-xl font-bold text-heading">${esc(p.display_name || 'No name')}</h1>
            <p class="text-muted text-sm">${esc(p.email || p.phone || '')}</p>
          </div>
        </div>
        <div class="space-y-4">
          <div>
            <label for="p-name" class="text-xs text-muted font-medium mb-1.5 block">Display Name</label>
            <input id="p-name" value="${esc(p.display_name || '')}" class="w-full bg-bg border border-border rounded-xl px-4 py-3 text-sm text-heading focus:outline-none focus:border-accent focus:ring-1 focus:ring-accent/30" />
          </div>
          <div>
            <label for="p-avatar" class="text-xs text-muted font-medium mb-1.5 block">Avatar URL</label>
            <input id="p-avatar" value="${esc(p.avatar_url || '')}" class="w-full bg-bg border border-border rounded-xl px-4 py-3 text-sm text-heading focus:outline-none focus:border-accent focus:ring-1 focus:ring-accent/30" />
          </div>
          <button onclick="doUpdateProfile()" id="profile-btn" class="w-full bg-accent hover:bg-accent-hover text-white font-semibold py-3 rounded-xl transition-colors active:scale-[0.97]">Update Profile</button>
        </div>
      </section>

      <!-- Preferences -->
      <section class="bg-surface rounded-2xl p-5 mb-4 shadow-card border border-border" aria-label="Preferences">
        <h3 class="text-sm font-semibold text-heading mb-4">Preferences</h3>

        <div class="mb-4">
          <label class="text-xs text-muted font-medium mb-2 block">Default Feed</label>
          <div class="flex gap-2">
            <button onclick="updateFeedPref('usersaved')" class="flex-1 py-2.5 rounded-xl text-sm font-medium transition-all duration-200 ${pref.feed_type === 'usersaved' ? 'bg-accent text-white shadow-sm' : 'bg-bg border border-border text-muted hover:text-heading'} active:scale-[0.97]">My Saved</button>
            <button onclick="updateFeedPref('suggestedcontent')" class="flex-1 py-2.5 rounded-xl text-sm font-medium transition-all duration-200 ${pref.feed_type === 'suggestedcontent' ? 'bg-accent text-white shadow-sm' : 'bg-bg border border-border text-muted hover:text-heading'} active:scale-[0.97]">Suggested</button>
          </div>
        </div>

        <div>
          <label class="text-xs text-muted font-medium mb-2 block">Theme</label>
          <div class="flex gap-2">
            ${['light', 'dark', 'system'].map(t => `
              <button onclick="applyTheme('${t}');renderProfile(document.getElementById('page'))" class="flex-1 py-2.5 rounded-xl text-sm font-medium transition-all duration-200 flex items-center justify-center gap-1.5 ${theme === t ? 'bg-accent text-white shadow-sm' : 'bg-bg border border-border text-muted hover:text-heading'} active:scale-[0.97]">
                <span class="material-icons-round text-base">${t === 'light' ? 'light_mode' : t === 'dark' ? 'dark_mode' : 'brightness_auto'}</span>
                ${t.charAt(0).toUpperCase() + t.slice(1)}
              </button>`).join('')}
          </div>
        </div>
      </section>

      <!-- Developer Tools (Collapsible) -->
      <section class="bg-surface rounded-2xl shadow-card border border-border mb-4 overflow-hidden" aria-label="Developer tools">
        <button onclick="document.getElementById('dev-tools').classList.toggle('hidden');this.querySelector('.expand-icon').classList.toggle('rotate-180')" class="w-full flex items-center justify-between p-5 hover:bg-surface-hover transition-colors">
          <div class="flex items-center gap-3">
            <span class="material-icons-round text-xl text-muted">code</span>
            <h3 class="text-sm font-semibold text-heading">Developer Tools</h3>
          </div>
          <span class="material-icons-round text-muted expand-icon transition-transform">expand_more</span>
        </button>
        <div id="dev-tools" class="hidden border-t border-border p-5 space-y-4">
          <!-- Cache -->
          <div>
            <h4 class="text-xs text-muted font-semibold uppercase tracking-wide mb-2">Cache</h4>
            <div class="flex gap-2">
              <input id="cache-pattern" placeholder="Pattern (optional)" class="flex-1 bg-bg border border-border rounded-xl px-3 py-2.5 text-sm text-heading focus:outline-none focus:border-accent" />
              <button onclick="doBustCache()" id="bust-btn" class="bg-accent hover:bg-accent-hover text-white text-sm font-semibold px-4 rounded-xl transition-colors active:scale-95">Bust</button>
            </div>
            <button onclick="loadCacheStats()" class="text-xs text-accent hover:text-accent-hover mt-2 font-medium">View Stats</button>
            <div id="cache-stats-result" class="mt-2"></div>
          </div>

          <!-- Prompts -->
          <div>
            <h4 class="text-xs text-muted font-semibold uppercase tracking-wide mb-2">Prompts</h4>
            <button onclick="doReloadPrompts()" id="prompts-btn" class="w-full bg-bg hover:bg-surface-hover border border-border text-heading text-sm font-medium py-2.5 rounded-xl transition-colors active:scale-[0.97] flex items-center justify-center gap-1.5">
              <span class="material-icons-round text-base">refresh</span> Reload Prompts
            </button>
          </div>

          <!-- Embedding Test -->
          <div>
            <h4 class="text-xs text-muted font-semibold uppercase tracking-wide mb-2">Generate Embedding</h4>
            <div class="flex gap-2">
              <input id="embed-text" placeholder="Text to embed..." class="flex-1 bg-bg border border-border rounded-xl px-3 py-2.5 text-sm text-heading focus:outline-none focus:border-accent" />
              <button onclick="doGenerateEmbedding()" id="embed-btn" class="bg-accent hover:bg-accent-hover text-white text-sm font-semibold px-4 rounded-xl transition-colors active:scale-95">Go</button>
            </div>
            <div id="embed-result" class="mt-2"></div>
          </div>

          <!-- Generate Feed -->
          <div>
            <h4 class="text-xs text-muted font-semibold uppercase tracking-wide mb-2">AI Feed</h4>
            <button onclick="doGenerateFeed()" id="gen-feed-btn" class="w-full bg-bg hover:bg-surface-hover border border-border text-heading text-sm font-medium py-2.5 rounded-xl transition-colors active:scale-[0.97] flex items-center justify-center gap-1.5">
              <span class="material-icons-round text-base">auto_awesome</span> Generate Feed
            </button>
            <div id="gen-feed-result" class="mt-2"></div>
          </div>

          <!-- Health Check -->
          <div>
            <h4 class="text-xs text-muted font-semibold uppercase tracking-wide mb-2">Health</h4>
            <button onclick="doHealthCheck()" id="health-btn" class="w-full bg-bg hover:bg-surface-hover border border-border text-heading text-sm font-medium py-2.5 rounded-xl transition-colors active:scale-[0.97] flex items-center justify-center gap-1.5">
              <span class="material-icons-round text-base">monitor_heart</span> Check Health
            </button>
            <div id="health-result" class="mt-2"></div>
          </div>
        </div>
      </section>

      <!-- Sign Out -->
      <button onclick="doLogout()" class="w-full flex items-center justify-center gap-2 bg-danger/10 hover:bg-danger/20 text-danger font-semibold py-3.5 rounded-xl transition-colors active:scale-[0.97]">
        <span class="material-icons-round text-lg">logout</span> Sign Out
      </button>
    </div>`;
}

async function doUpdateProfile() {
  const btn = document.getElementById('profile-btn');
  btn.innerHTML = '<div class="spinner" style="width:18px;height:18px;border-width:2px;"></div>';
  btn.disabled = true;
  const body = {
    display_name: document.getElementById('p-name').value.trim() || null,
    avatar_url: document.getElementById('p-avatar').value.trim() || null,
  };
  const res = await api('PATCH', '/api/profile', body);
  if (res.ok) { _userProfile = null; toast('Profile updated!'); }
  else toast(res.data?.detail || 'Failed to update', true);
  btn.textContent = 'Update Profile';
  btn.disabled = false;
}

async function updateFeedPref(type) {
  await api('PATCH', '/api/user-preferences', { feed_type: type });
  toast('Feed preference updated!');
  await renderProfile(document.getElementById('page'));
}

// ─── Admin action handlers ───
async function loadCacheStats() {
  const statsRes = await api('GET', '/api/admin/cache/stats');
  const el = document.getElementById('cache-stats-result');
  if (statsRes.ok) el.innerHTML = `<pre class="text-xs text-muted bg-bg rounded-xl p-3 overflow-x-auto max-h-32">${esc(JSON.stringify(statsRes.data, null, 2))}</pre>`;
  else el.innerHTML = `<p class="text-danger text-xs">Failed to load stats</p>`;
}

async function doBustCache() {
  const btn = document.getElementById('bust-btn');
  btn.innerHTML = '<div class="spinner" style="width:14px;height:14px;border-width:2px;"></div>';
  btn.disabled = true;
  const pattern = document.getElementById('cache-pattern').value.trim();
  const res = await api('POST', '/api/admin/cache/bust', null, pattern ? { pattern } : null);
  if (res.ok) toast('Cache busted!');
  else toast(res.data?.detail || 'Failed', true);
  btn.textContent = 'Bust';
  btn.disabled = false;
}

async function doReloadPrompts() {
  const btn = document.getElementById('prompts-btn');
  btn.innerHTML = '<div class="spinner" style="width:16px;height:16px;border-width:2px;"></div>';
  btn.disabled = true;
  const res = await api('POST', '/api/admin/prompts/reload');
  if (res.ok) toast('Prompts reloaded!');
  else toast(res.data?.detail || 'Failed', true);
  btn.innerHTML = '<span class="material-icons-round text-base">refresh</span> Reload Prompts';
  btn.disabled = false;
}

async function doGenerateEmbedding() {
  const text = document.getElementById('embed-text').value.trim();
  if (!text) { toast('Enter text', true); return; }
  const btn = document.getElementById('embed-btn');
  btn.innerHTML = '<div class="spinner" style="width:14px;height:14px;border-width:2px;"></div>';
  btn.disabled = true;
  const res = await api('POST', '/api/ai/generate-embedding', { text });
  const el = document.getElementById('embed-result');
  if (res.ok) {
    const dim = res.data.embedding?.length || 0;
    el.innerHTML = `<p class="text-success text-xs">Embedding generated (${dim} dimensions)</p><pre class="text-xs text-muted bg-bg rounded-lg p-2 mt-1 max-h-24 overflow-y-auto">[${res.data.embedding?.slice(0, 5).map(n => n.toFixed(6)).join(', ')}... ]</pre>`;
  } else el.innerHTML = `<p class="text-danger text-xs">${esc(res.data?.detail || 'Failed')}</p>`;
  btn.textContent = 'Go';
  btn.disabled = false;
}

async function doGenerateFeed() {
  const btn = document.getElementById('gen-feed-btn');
  btn.innerHTML = '<div class="spinner" style="width:16px;height:16px;border-width:2px;"></div> Generating...';
  btn.disabled = true;
  const res = await api('POST', '/api/ai/generate-feed');
  const el = document.getElementById('gen-feed-result');
  if (res.ok) {
    const count = res.data.items?.length || 0;
    el.innerHTML = `<p class="text-success text-xs">${count} feed items generated</p>`;
    if (res.data.message) el.innerHTML += `<p class="text-muted text-xs mt-1">${esc(res.data.message)}</p>`;
  } else el.innerHTML = `<p class="text-danger text-xs">${esc(res.data?.detail || 'Failed')}</p>`;
  btn.innerHTML = '<span class="material-icons-round text-base">auto_awesome</span> Generate Feed';
  btn.disabled = false;
}

async function doHealthCheck() {
  const btn = document.getElementById('health-btn');
  btn.innerHTML = '<div class="spinner" style="width:16px;height:16px;border-width:2px;"></div>';
  btn.disabled = true;
  const res = await api('GET', '/health');
  document.getElementById('health-result').innerHTML = `<pre class="text-xs ${res.ok ? 'text-success' : 'text-danger'} bg-bg rounded-lg p-2 mt-1">${esc(JSON.stringify(res.data, null, 2))}</pre>`;
  btn.innerHTML = '<span class="material-icons-round text-base">monitor_heart</span> Check Health';
  btn.disabled = false;
}
</script>

</body>
</html>
